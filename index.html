<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Monitor de Alarmas ESP32</title>
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
    }

    .tabs {
      display: flex;
      cursor: pointer;
      margin-bottom: 10px;
    }

    .tab {
      padding: 10px 20px;
      border: 1px solid #ccc;
      border-bottom: none;
      background-color: #f1f1f1;
    }

    .tab.active {
      background-color: white;
      font-weight: bold;
    }

    .tab-content {
      display: none;
      border: 1px solid #ccc;
      padding: 10px;
    }

    .tab-content.active {
      display: block;
    }

    .alarm {
      border: 1px solid #ccc;
      border-radius: 5px;
      padding: 10px;
      margin: 10px 0;
      font-size: 16px;
    }

    .active {
      background-color: #ffe5e5;
      color: #b30000;
      font-weight: bold;
    }

    .inactive {
      background-color: #e5ffe5;
      color: #007000;
    }

    .byte-info {
      font-size: 18px;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h2>Estado de Alarmas (desde ESP32 v√≠a EMQX)</h2>

  <div class="tabs">
    <div class="tab active" onclick="showTab(0)">Alarmas Externas</div>
    <div class="tab" onclick="showTab(1)">Alarmas Internas</div>
  </div>

  <div id="tab-0" class="tab-content active">
    <div class="byte-info" id="byte-external">Esperando datos externos...</div>
    <div id="alarms-external"></div>
  </div>

  <div id="tab-1" class="tab-content">
    <div class="byte-info" id="byte-internal">Esperando datos internos...</div>
    <div id="alarms-internal"></div>
  </div>

  <script>
    // MQTT conexi√≥n WebSocket
    const client = mqtt.connect('wss://d4e6f442.ala.us-east-1.emqxsl.com:8084/mqtt', {
      clientId: 'web_' + Math.random().toString(16).substr(2, 8),
      username: 'Olivas',
      password: 'Jangel27'
    });

    // Nombres de alarmas para cada byte
    const alarmNamesExternal = [
      "FALLA*ALIM*COM*ITR",     
      "GPO*ELEC*OPER*ITR",       
      "FALLA*FUS*DIST*A*ITR",    
      "FALLA*RECT*A*ITR",        
      "ALTA*TEMP*CX*ITR",        
      "FALLA*FUS*VOLTA*A*ITR",   
      "BAT*EN*OPER*A*ITR",       
      "BAJO*VOLTAJE*A*ITR"   
      "PUERTA*ABIERTA*INT",      
      "INTRUSI√ìN*DETECTADA",     
      "ERROR*DE*SENSOR",         
      "BATER√çA*BAJA",            
      "SISTEMA*REINICIADO",      
      "MANTENIMIENTO*REQUERIDO", 
      "FALLA*DE*COMUNICACI√ìN",   
      "ALARMA*MANUAL*ACTIVADA"
    ];

    const alarmNamesInternal = [
      "PUERTA*ABIERTA*INT",      
      "INTRUSI√ìN*DETECTADA",     
      "ERROR*DE*SENSOR",         
      "BATER√çA*BAJA",            
      "SISTEMA*REINICIADO",      
      "MANTENIMIENTO*REQUERIDO", 
      "FALLA*DE*COMUNICACI√ìN",   
      "ALARMA*MANUAL*ACTIVADA"   
    ];

    client.on('connect', () => {
      console.log('Conectado a EMQX');
      client.subscribe('esp32/External_Alarms');
      client.subscribe('esp32/Internal_Alarms');
    });

    //client.on('message', (topic, message) => {
      //const byteValue = message[0];
      //const binStr = byteValue.toString(2).padStart(8, '0');

      //if (topic === 'esp32/External_Alarms') {
        //document.getElementById('byte-external').textContent = `Byte recibido (externo): ${byteValue} (bin: ${binStr})`;
        //updateAlarms('alarms-external', byteValue, alarmNamesExternal);
      //} else if (topic === 'esp32/Internal_Alarms') {
        //document.getElementById('byte-internal').textContent = `Byte recibido (interno): ${byteValue} (bin: ${binStr})`;
        //updateAlarms('alarms-internal', byteValue, alarmNamesInternal);
      //}
    //});
    client.on('message', (topic, message) => {
    if (topic === 'esp32/Alarms' && message.length >= 2) {
    const byte1 = message[0]; // pines 0-7
    const byte2 = message[1]; // pines 8-15

    document.getElementById('byte-external').textContent = `Byte 1 (pines 0‚Äì7): ${byte1} (bin: ${byte1.toString(2).padStart(8, '0')})`;
    document.getElementById('byte-internal').textContent = `Byte 2 (pines 8‚Äì15): ${byte2} (bin: ${byte2.toString(2).padStart(8, '0')})`;

    updateAlarms('alarms-external', byte1, alarmNamesExternal);
    updateAlarms('alarms-internal', byte2, alarmNamesInternal);
  }
});


    function updateAlarms(containerId, byteValue, alarmNames) {
      const container = document.getElementById(containerId);
      container.innerHTML = '';

     // for (let i = 7; i >= 0; i--) {
        for (let i = 15; i >= 0; i--) {
        const bit = (byteValue >> i) & 1;
        const div = document.createElement('div');
        div.className = 'alarm ' + (bit ? 'active' : 'inactive');
        div.textContent = `D${i} - ${alarmNames[i]}: ${bit ? 'üî• Alarma activa' : '‚úÖ Sin alarma'}`;
        container.appendChild(div);
      }
    }

    function showTab(index) {
      const tabs = document.querySelectorAll('.tab');
      const contents = document.querySelectorAll('.tab-content');
      tabs.forEach((tab, i) => {
        tab.classList.toggle('active', i === index);
        contents[i].classList.toggle('active', i === index);
      });
    }
  </script>
</body>
</html>
