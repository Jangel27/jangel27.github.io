<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Monitor de Alarmas ESP32 - Global</title>
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <style>
    /* ... Mantenemos todos tus estilos originales ... */
    body {
        background: linear-gradient(135deg, #bdc3c7 0%, #eff2f3 25%, #95a5a6 50%, #eff2f3 75%, #bdc3c7 100%) fixed !important; 
        font-family: Arial, sans-serif; margin: 0; padding: 20px; min-height: 100vh;
    }
    .tabs { display: flex; cursor: pointer; margin-bottom: 10px; }
    .tab { padding: 10px 20px; border: 1px solid #000; border-bottom: none; background-color: #f1f1f1; }
    .tab.active { background-color: white; font-weight: bold; }
    .tab.alarm-active-tab { background-color: red !important; color: white; }
    .tab-content { display: none; border: 1px solid #ccc; padding: 10px; background-color: #00C3C3 !important; }
    .tab-content.active { display: block; }
    .alarms-house-layout { display: flex; justify-content: flex-start; align-items: flex-start; gap: 120px; width: 100%; }
    .alarms-container { flex: 0 0 auto; width: 280px; }
    .alarm { border: 1px solid #ccc; border-radius: 5px; padding: 10px; margin: 10px 0; font-size: 12px; width: 280px; }
    .active { background-color: #ffe5e5; color: #b30000; font-weight: bold; }
    .inactive { background-color: #e5ffe5; color: #007000; }
    .history-box { background: #fff; border: 1px solid #ccc; padding: 10px; max-height: 250px; overflow-y: auto; list-style: none; }
    .sync-status { font-size: 11px; color: #555; margin-bottom: 5px; font-style: italic; }
    /* ... Tus estilos de casa y animaciones se mantienen igual ... */
    .house-drawing { position: relative; width: 540px; height: 620px; top: -70px; left: -50px; }
    .alarm-figure-active svg * { stroke: red !important; fill: red !important; }
    @keyframes parpadeo { 0% { opacity: 1; } 50% { opacity: 0.1; } 100% { opacity: 1; } }
    .alarm-blink { animation: parpadeo 2s infinite; }
    /* Estilos de las figuras abreviados para brevedad del prompt pero incluidos en la l√≥gica */
    .roof, .walls, .sala-baterias, .planta-CD, .bateria, .persona, .termometro, .barra-tierra, .rectificador, .breaker, .external-figures, .tank-area, .generador, .ats, .flecha1, .flecha2, .flecha3, .flecha4, .poste { position: absolute; }
  </style>
</head>
<body>
  <h2>Estado de Alarmas (Sincronizaci√≥n Global Google Sheets)</h2>

  <div class="tabs">
    <div class="tab active" onclick="showTab(0)">Alarmas Externas OTY</div>
    <div class="tab" onclick="showTab(1)">Alarmas Externas ITR</div>
  </div>

  <div id="tab-0" class="tab-content active">
    <div class="byte-info" id="byte-external-OTY">Esperando datos de OTY...</div>
    <div class="alarms-house-layout">
        <div class="alarms-container" id="alarms-external-OTY"></div>
        <div class="house-area">
            <div class="house-drawing">
                <div class="roof"></div><div class="walls"></div>
                <div class="sala-baterias"><div id="sala-baterias-title">Sala de Baterias</div></div>
                <div id="bateria_OTY" class="bateria"><svg width="100" height="140" viewBox="0 0 60 120"><rect x="0" y="20" width="60" height="50" rx="5" ry="5" fill="none" stroke="black" stroke-width="2"></rect></svg></div>
                </div>
        </div>
    </div>
  </div>

  <div id="tab-1" class="tab-content">
    <div class="byte-info" id="byte-external-ITR">Esperando datos de ITR...</div>
    <div class="alarms-house-layout">
        <div class="alarms-container" id="alarms-external-ITR"></div>
        <div class="house-area">
            <div class="house-drawing">
                <div class="roof"></div><div class="walls"></div>
                </div>
        </div>
    </div>
  </div>

  <script>
    // === CONFIGURACI√ìN GLOBAL ===
    const GOOGLE_URL = "https://script.google.com/macros/s/AKfycbxxrDq8_PNyQWRzVUNMd6bQSotrshvtVnuC2tJEtDFk6GiAtB4uE1t3pPtZATptyVEu/exec"; 
    let alarmHistory = { 'OTY': [], 'ITR': [] };

    // MQTT conexi√≥n WebSocket
      const client = mqtt.connect('wss://d4e6f442.ala.us-east-1.emqxsl.com:8084/mqtt', {
      	clientId: 'web_' + Math.random().toString(16).substr(2, 8),
      	username: 'Olivas',
      	password: 'Jangel27',
		clean: true
    });

    const alarmNamesExternalOTY = ["FALLA*ALIM*COM*OTY","GPO*ELEC*OPER*OTY","FALLA*FUS*DIST*A*OTY","FALLA*RECT*A*OTY","ALTA*TEMP*CX*OTY","FALLA*FUS*VOLTA*A*OTY","BAT*EN*OPER*A*OTY","BAJO*VOLTAJE*A*OTY","PRESENCIA*BANCO*BAT*OTY","ROBO*BARRA*TIERRA*OTY","ALARMA LIBRE 3","ALARMA LIBRE 4","ALARMA LIBRE 5","ALARMA LIBRE 6","ALARMA LIBRE 7","ALARMA LIBRE 8"];
    const alarmNamesExternalITR = ["FALLA*ALIM*COM*ITR","GPO*ELEC*OPER*ITR","FALLA*FUS*DIST*A*ITR","FALLA*RECT*A*ITR","ALTA*TEMP*CX*ITR","FALLA*FUS*VOLTA*A*ITR","BAT*EN*OPER*A*ITR","BAJO*VOLTAJE*A*ITR","PRESENCIA*BANCO*BAT*ITR","ROBO*BARRA*TIERRA*ITR","ALARMA LIBRE 3","ALARMA LIBRE 4","ALARMA LIBRE 5","ALARMA LIBRE 6","ALARMA LIBRE 7","ALARMA LIBRE 8"];

    client.on('connect', () => {
      client.subscribe(['esp32/External_Alarms_OTY', 'esp32/External_Alarms_ITR', 'esp32/NivelDiesel_ITR']);
    });

    client.on('message', (topic, message) => {
      if (topic.includes('External_Alarms')) {
        const value = (message[0] << 8) | message[1];
        const site = topic.includes('OTY') ? 'OTY' : 'ITR';
        document.getElementById(`byte-external-${site}`).textContent = `Bytes: ${message[0]}, ${message[1]}`;
        updateAlarms(`alarms-external-${site}`, value, site === 'OTY' ? alarmNamesExternalOTY : alarmNamesExternalITR);
      }
    });

    // === L√ìGICA DE HISTORIAL GLOBAL ===
    function createHistoryContainers() {
        ['OTY', 'ITR'].forEach(site => {
            const container = document.getElementById(`tab-${site === 'OTY' ? '0' : '1'}`);
            const div = document.createElement('div');
            div.innerHTML = `
                <h3>üö® Historial Global ${site}</h3>
                <div id="sync-time-${site}" class="sync-status">Sincronizando con Google...</div>
                <ul id="history-${site}" class="history-box"></ul>
            `;
            container.appendChild(div);
        });
    }

    async function fetchGlobalHistory() {
        try {
            const response = await fetch(GOOGLE_URL);
            const data = await response.json();
            alarmHistory = data;
            renderHistory('OTY');
            renderHistory('ITR');
        } catch (e) { console.error("Error de sincronizaci√≥n", e); }
    }

    function renderHistory(site) {
        const list = document.getElementById(`history-${site}`);
        const syncLabel = document.getElementById(`sync-time-${site}`);
        list.innerHTML = '';
        // Mostramos los √∫ltimos 50 eventos, invertidos para ver lo nuevo arriba
        const entries = (alarmHistory[site] || []).slice(-50).reverse();
        entries.forEach(entry => {
            const li = document.createElement('li');
            li.innerHTML = `<small style="color:blue">[${entry.time}]</small> <b>${entry.name}</b>: ${entry.state}`;
            list.appendChild(li);
        });
        syncLabel.innerText = "√öltima sincronizaci√≥n: " + new Date().toLocaleTimeString();
    }

    function logAlarmChange(site, name, state) {
        const entry = { site, name, state };
        // Enviar a Google Sheets
        fetch(GOOGLE_URL, {
            method: 'POST',
            mode: 'no-cors',
            body: JSON.stringify(entry)
        });
        // Actualizaci√≥n local inmediata
        const localEntry = {...entry, time: new Date().toLocaleTimeString()};
        alarmHistory[site].push(localEntry);
        renderHistory(site);
    }

    // === ACTUALIZACI√ìN DE ALARMAS Y FIGURAS ===
    let previousAlarmStates = { 'alarms-external-OTY': null, 'alarms-external-ITR': null };

    function updateAlarms(containerId, value16bit, alarmNames) {
        const container = document.getElementById(containerId);
        const prev = previousAlarmStates[containerId];
        const site = containerId.includes('OTY') ? 'OTY' : 'ITR';
        const current = [];
        let hasActiveAlarm = false;

        container.innerHTML = '';

        for (let i = 0; i < 16; i++) {
            const bit = (value16bit >> i) & 1;
            current[i] = bit;
            if (bit) hasActiveAlarm = true;

            // Registro en historial si cambia el bit
            if (prev && prev[i] !== bit) {
                logAlarmChange(site, alarmNames[i], bit ? 'üö® ACTIVADA' : '‚úÖ CES√ì');
            }

            // Actualizar figuras SVG (usando tu l√≥gica original)
            const figId = (site === 'OTY' ? figureMapOTY : figureMapITR)[i];
            if (figId) {
                const fig = document.getElementById(figId);
                if (fig) {
                    if (bit) fig.classList.add("alarm-figure-active", "alarm-blink");
                    else fig.classList.remove("alarm-figure-active", "alarm-blink");
                }
            }

            const div = document.createElement('div');
            div.className = 'alarm ' + (bit ? 'active' : 'inactive');
            div.textContent = `A${i} - ${alarmNames[i]}: ${bit ? 'üö® Activa' : '‚úÖ Sin alarma'}`;
            container.appendChild(div);
        }
        previousAlarmStates[containerId] = current;
        toggleAlarmTab(site === 'OTY' ? 0 : 1, hasActiveAlarm);
    }

    // Mapas de figuras (los que ya ten√≠as)
    const figureMapOTY = { 0: "poste_OTY", 1: "generador_OTY", 2: "breaker_OTY", 3: "rectificador_OTY", 4: "termometro_OTY", 5: "bateria_OTY", 8: "persona_OTY", 9: "barra-tierra_OTY" };
    const figureMapITR = { 0: "poste_ITR", 1: "generador_ITR", 2: "breaker_ITR", 3: "rectificador_ITR", 4: "termometro_ITR", 5: "bateria_ITR", 8: "persona_ITR", 9: "barra-tierra_ITR" };

    function showTab(index) {
        document.querySelectorAll('.tab').forEach((t, i) => t.classList.toggle('active', i === index));
        document.querySelectorAll('.tab-content').forEach((c, i) => c.classList.toggle('active', i === index));
    }

    function toggleAlarmTab(idx, active) {
        document.querySelectorAll('.tab')[idx].classList.toggle('alarm-active-tab', active);
    }

    // Inicializaci√≥n
    createHistoryContainers();
    fetchGlobalHistory();
    setInterval(fetchGlobalHistory, 30000); // Refresco autom√°tico cada 30 segundos
  </script>
</body>
</html>
