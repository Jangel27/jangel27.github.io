<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Monitor de Alarmas ESP32</title>
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
    }

    .tabs {
      display: flex;
      cursor: pointer;
      margin-bottom: 10px;
    }

    .tab {
      padding: 10px 20px;
      border: 1px solid #ccc;
      border-bottom: none;
      background-color: #f1f1f1;
    }

    .tab.active {
      background-color: white;
      font-weight: bold;
    }

    .tab.alarm-active-tab {
      background-color: red !important;
      color: white;
    }

    .tab-content {
      display: none;
      border: 1px solid #ccc;
      padding: 10px;
      background-color: #d8d8d8;
    }

    .tab-content.active {
      display: block;
    }

    .alarms-house-layout {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 20px;
    }

    .alarms-container {
      flex: 1;
    }

    .alarm {
      border: 1px solid #ccc;
      border-radius: 5px;
      padding: 10px;
      margin: 10px 0;
      font-size: 12px;
      width: 270px;
    }

    .active {
      background-color: #ffe5e5;
      color: #b30000;
      font-weight: bold;
    }

    .inactive {
      background-color: #e5ffe5;
      color: #007000;
    }

    .byte-info {
      font-size: 16px;
      font-weight: bold;
    }

    /* ====== √Årea de la casa ====== */
    .house-area {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-top: 40px;
    }

    .house-drawing {
      position: relative;
      width: 540px;
      height: 620px;
      top: -70px;
      left: -50px;
    }

    .roof {
      position: absolute;
      top: -60px;
      left: 0;
      width: 0;
      height: 0;
      border-left: 270px solid transparent;
      border-right: 270px solid transparent;
      border-bottom: 200px solid transparent;
    }

    .roof::before,
    .roof::after {
      content: "";
      position: absolute;
      top: 0;
      width: 2px;
      height: 320px;
      background-color: #000;
    }

    .roof::before {
      left: -270px;
      transform: rotate(57deg);
      transform-origin: bottom right;
    }

    .roof::after {
      right: -270px;
      transform: rotate(-57deg);
      transform-origin: bottom left;
    }

    .roof .base-line {
      position: absolute;
      bottom: 0;
      left: -270px;
      width: 540px;
      height: 2px;
      background-color: #000;
    }

    .walls {
      position: absolute;
      bottom: 0;
      width: 540px;
      height: 360px;
      background-color: transparent;
      border: 2px solid #000000;
      box-sizing: border-box;
    }

    .door {
      position: absolute;
      bottom: 0;
      left: 0;
      width: 150px;
      height: 220px;
      background-color: transparent;
      border: 2px solid #000000;
      box-sizing: border-box;
    }

    .window {
      position: absolute;
      bottom: 0;
      left: 390px;
      width: 150px;
      height: 220px;
      background-color: transparent;
      border: 2px solid #000000;
      box-sizing: border-box;
    }
    .bateria{
      position: absolute;
      bottom: -50px;
      left: 25px;
    }
    .persona{
      position: absolute;
      bottom: 15px;
      left: 5px;
    }
    .termometro{
      position: absolute;
      bottom: 220px;
      left: 250px;
    }
    .barra-tierra{
      position: absolute;
      bottom: 230px;
      left: 410px;
    }
    .rectificador{
      position: absolute;
      bottom: -10px;
      left: 405px;
    }
    .breaker{
      position: absolute;
      bottom: 120px;
      left: 415px;
    }
    .tank-container {
      display: flex;
      justify-content: center;
      align-items: center;
    }
    #diesel-tank {
      position: absolute;
      bottom: -220px;
      left: -60px;
      width: 155px;
      height: 75px;
      border: 4px solid #555;
      border-radius: 60px;
      background: radial-gradient(circle at 50% 30%, #fff176 0%, #FAD201 60%, #c9a801 100%);
      box-shadow: inset -6px 0 10px rgba(0, 0, 0, 0.3),
                  inset 6px 0 10px rgba(255, 255, 255, 0.5);
      overflow: hidden;
    }

    #diesel-fill {
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 0%;
      background: linear-gradient(to top, #007b00, #00ff00);
      border-radius: 0 0 40px 40px;
      transition: height 0.8s ease, background 0.6s ease;
      box-shadow: inset 0 2px 5px rgba(255, 255, 255, 0.5);
    }

    #diesel-text {
      position: absolute;
      width: 100%;
      text-align: center;
      bottom: 10px;
      font-weight: bold;
      color: #000;
      font-size: 20px;
      text-shadow: 1px 1px 2px rgba(255,255,255,0.9);
    }
    .generador{
      position: absolute;
      bottom: -255px;
      left: 130px;
    }
    /* Solo l√≠neas, sin relleno */
    .gen-body, .gen-base {
        fill: none;
        stroke: black;
        stroke-width: 2;
    }
    .button {
        margin: 10px;
        padding: 8px 12px;
        cursor: pointer;
    }
    .ats{
      position: absolute;
      bottom: -240px;
      left: 350px;
    }
    .flecha-rayo1{
      position: absolute;
      bottom: -200px;
      left: 260px;
    }
      .flecha-rayo2{
      position: absolute;
      bottom: -250px;
      left: 460px;
    }
      .flecha-rayo3{
      position: absolute;
      bottom: -130px;
      left: 375px;
    }
    .poste{
      position: absolute;
      bottom: -245px;
      left: 515px;
    }
    .history-box {
      background: #fff;
      border: 1px solid #ccc;
      padding: 10px;
      max-height: 200px;
      overflow-y: auto;
    }

    .clear-btn {
      margin: 5px 0;
      padding: 5px 10px;
      background: #ff6666;
      color: #fff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .clear-btn:hover {
      background: #e60000;
    }
    
    
  </style>
</head>
<body>
  <h2>Estado de Alarmas (desde ESP32 v√≠a EMQX)</h2>

  <div class="tabs">
    <div class="tab active" onclick="showTab(0)">Alarmas Externas OTY</div>
    <div class="tab" onclick="showTab(1)">Alarmas Externas ITR</div>
  </div>

  <!-- TAB 0: OTY -->
  <div id="tab-0" class="tab-content active">
    <div class="byte-info" id="byte-external-OTY">Esperando datos de OTY...</div>
    <div class="alarms-house-layout">
      <div class="alarms-container" id="alarms-external-OTY"></div>
      <div class="house-area">
        <div class="house-drawing">
          <div class="roof"></div>
          <div class="walls"></div>
          <div class="door"></div>
          <div class="window"></div>
          <div id="bateria" class="bateria">
          <svg width="100" height="140" viewBox="0 0 60 120">
          <rect x="0" y="20" width="60" height="50" rx="5" ry="5" fill="none" stroke="black" stroke-width="2"></rect>
          <line x1="15" y1="20" x2="15" y2="70" stroke="black" stroke-width="1"></line>
          <line x1="30" y1="20" x2="30" y2="70" stroke="black" stroke-width="1"></line>
          <line x1="45" y1="20" x2="45" y2="70" stroke="black" stroke-width="1"></line>
          <rect x="8" y="10" width="15" height="10" fill="red"></rect>
          <text x="15.5" y="18" font-size="10" text-anchor="middle" fill="white" font-family="Arial" font-weight="bold">+</text>
          <rect x="13" y="5" width="5" height="5" fill="red"></rect>
          <rect x="38" y="10" width="15" height="10" fill="black"></rect>
          <text x="45.5" y="18" font-size="10" text-anchor="middle" fill="white" font-family="Arial" font-weight="bold">-</text>
          <rect x="43" y="5" width="5" height="5" fill="black"></rect>
          </svg>
          </div>
          <div id="persona" class="persona">
          <svg width="150" height="220" viewBox="0 0 120 180">
          <circle cx="52.5" cy="34" r="8" fill="none" stroke="black" stroke-width="3"/>
          <rect x="45" y="45" width="15" height="30" fill="none" stroke="black" stroke-width="3" rx="3"/>
          <rect x="40" y="45" width="5" height="25" fill="none" stroke="black" stroke-width="3" rx="3"/>
          <rect x="60" y="45" width="5" height="25" fill="none" stroke="black" stroke-width="3" rx="3" />
          <rect x="47.5" y="75" width="5" height="28" fill="none" stroke="black" stroke-width="3" rx="3"/>
          <rect x="52.5" y="75" width="5" height="28" fill="none" stroke="black" stroke-width="3" rx="3"/>
          </svg>
          </div>
          <div id="termometro" class="termometro">
          <svg width="45" height="154" viewBox="0 0 30 100">
          <g transform="scale(0.75)" vector-effect="non-scaling-stroke">
          <circle cx="15" cy="90" r="10" fill="red" stroke="black" stroke-width="2"></circle>
          <rect x="12" y="32" width="6" height="50" fill="none" stroke="black" stroke-width="2" rx="3"></rect>
          <rect x="13" y="40" width="4" height="50" fill="red"></rect>
          <line x1="18" y1="40" x2="22" y2="40" stroke="black" stroke-width="1"></line>
          <line x1="18" y1="50" x2="22" y2="50" stroke="black" stroke-width="1"></line>
          <line x1="18" y1="60" x2="22" y2="60" stroke="black" stroke-width="1"></line>
          <line x1="18" y1="70" x2="22" y2="70" stroke="black" stroke-width="1"></line>
          </g>
          </svg>
          </div>
          <div id="barra-tierra" class="barra-tierra">
          <svg width="160" height="80" viewBox="0 0 160 80" xmlns="http://www.w3.org/2000/svg">
          <g transform="scale(0.75)" vector-effect="non-scaling-stroke">
          <rect x="5" y="5" width="150" height="70" fill="none" stroke="black" stroke-width="2" rx="5" ry="5" />
          <line x1="80" y1="20" x2="80" y2="45" stroke="black" stroke-width="4" />
          <line x1="55" y1="45" x2="105" y2="45" stroke="black" stroke-width="4" />
          <line x1="60" y1="55" x2="100" y2="55" stroke="black" stroke-width="4" />
          <line x1="65" y1="65" x2="95"  y2="65" stroke="black" stroke-width="4" />
          </g>
          </svg>
          </div>
          <div id="rectificador" class="rectificador">
          <svg width="150" height="75" viewBox="0 0 200 100" xmlns="http://www.w3.org/2000/svg">
          <g transform="scale(0.75)">
          <line x1="0" y1="30" x2="40" y2="30" stroke="black" stroke-width="3"/>
          <line x1="0" y1="70" x2="40" y2="70" stroke="black" stroke-width="3"/>
          <rect x="40" y="10" width="120" height="80" fill="none" stroke="black" stroke-width="3"/>
          <line x1="40" y1="10" x2="160" y2="90" stroke="black" stroke-width="1"/>
          <path d="M 50 60 q 10 -40 20 0 q 10 40 20 0" fill="none" stroke="black" stroke-width="3" />
          <line x1="130" y1="35" x2="150" y2="35" stroke="black" stroke-width="5" />
          <line x1="130" y1="45" x2="150" y2="45" stroke="black" stroke-width="3" />
          <line x1="160" y1="30" x2="200" y2="30" stroke="black" stroke-width="3" />
          <line x1="160" y1="70" x2="200" y2="70" stroke="black" stroke-width="3" />
          <text x="205" y="35" font-family="Arial" font-size="20" fill="black">+</text>
          <text x="205" y="75" font-family="Arial" font-size="20" fill="black">‚àí</text>
          </g>
          </svg>
          </div>
          <div id="breaker" class="breaker">
          <svg width="90" height="60" viewBox="0 0 160 120" stroke="black" stroke-width="3" fill="none" stroke-linejoin="round">
          <g transform="scale(1.1)">
          <rect x="10" y="20" width="40" height="80" rx="2" ry="2"></rect>
          <rect x="60" y="20" width="40" height="80" rx="2" ry="2"></rect>
          <rect x="110" y="20" width="40" height="80" rx="2" ry="2"></rect>
          <rect x="18" y="10" width="20" height="10" rx="1" ry="1"></rect>
          <rect x="68" y="10" width="20" height="10" rx="1" ry="1"></rect>
          <rect x="118" y="10" width="20" height="10" rx="1" ry="1"></rect>
          <circle cx="28" cy="15" r="4"></circle>
          <circle cx="78" cy="15" r="4"></circle>
          <circle cx="128" cy="15" r="4"></circle>
          <rect x="18" y="100" width="20" height="10" rx="1" ry="1"></rect>
          <rect x="68" y="100" width="20" height="10" rx="1" ry="1"></rect>
          <rect x="118" y="100" width="20" height="10" rx="1" ry="1"></rect>
          <circle cx="28" cy="105" r="4"></circle>
          <circle cx="78" cy="105" r="4"></circle>
          <circle cx="128" cy="105" r="4"></circle>
          <rect x="25" y="50" width="10" height="25" rx="1" ry="1" fill="white" stroke="black" stroke-width="3"></rect>
          <line x1="30" y1="50" x2="30" y2="60" stroke="black" stroke-width="3" stroke-linecap="round"></line>
          <rect x="75" y="50" width="10" height="25" rx="1" ry="1" fill="white" stroke="black" stroke-width="3"></rect>
          <line x1="80" y1="50" x2="80" y2="60" stroke="black" stroke-width="3" stroke-linecap="round"></line>
          <rect x="125" y="50" width="10" height="25" rx="1" ry="1" fill="white" stroke="black" stroke-width="3"></rect>
          <line x1="130" y1="50" x2="130" y2="60" stroke="black" stroke-width="3" stroke-linecap="round"></line>
          </g>
          </svg>
          </div>
          <div id="generador" class="generador">
            <svg width="200" height="150" viewBox="0 0 200 150">
            <rect class="gen-base" x="20" y="100" width="160" height="20" rx="4"></rect>
            <rect class="gen-body" x="40" y="40" width="120" height="60" rx="8"></rect>
            <text x="102" y="95" font-size="28" text-anchor="middle" fill="black" font-family="Arial" font-weight="bold">G E</text>
            <polyline points="100,45 90,70 110,70 100,95" stroke="orange" stroke-width="3" fill="none"></polyline>
            <circle cx="60" cy="60" r="5" fill="red"></circle>
            <circle cx="140" cy="60" r="5" fill="green"></circle>
            </svg>
           </div>
            <div id="ats" class="ats">
             <svg width="150" height="120" viewBox="0 0 150 120">  
             <rect x="10" y="20" width="130" height="80" rx="10" fill="none" stroke="black" stroke-width="2"></rect>
             <text x="75" y="50" font-size="16" text-anchor="middle" fill="black" font-family="Arial" font-weight="bold">ATS</text>
             <line x1="75" y1="60" x2="75" y2="90" stroke="black" stroke-width="4" stroke-linecap="round"></line>
             <circle cx="75" cy="90" r="6" fill="gray" stroke="black" stroke-width="2"></circle>
             <text x="45" y="110" font-size="12" text-anchor="middle" fill="red" font-family="Arial" font-weight="bold">GEN</text>
             <text x="105" y="110" font-size="12" text-anchor="middle" fill="green" font-family="Arial" font-weight="bold">RED</text>
             <line x1="75" y1="90" x2="45" y2="105" stroke="red" stroke-width="2"></line>
             <line x1="75" y1="90" x2="105" y2="105" stroke="green" stroke-width="2"></line>
             </svg>
             </div> 
             <div id="flecha-rayo1" class="flecha-rayo1">
             <svg width="350" height="200" viewBox="0 0 300 200">
             <defs>
             <!-- Punta de flecha fija horizontal -->
             <marker id="arrow" markerWidth="10" markerHeight="10" refX="20" refY="3" orient="0" markerUnits="strokeWidth">
             <path d="M0,0 L0,6 L9,3 z" fill="orange"/>
             </marker>
             </defs>
             <g transform="scale(0.95)" vector-effect="non-scaling-stroke">
             <!-- Zig-zag original -->
             <polyline points="45,100 70,90 70,110 95,100" stroke="orange" stroke-width="3" fill="none" marker-end="url(#arrow)"/>
             </g>
             </svg>
             </div>

             <div id="flecha-rayo2" class="flecha-rayo2">
             <svg width="300" height="80" viewBox="0 0 300 80">
             <g transform="scale(0.35) rotate(180 150 40)" vector-effect="non-scaling-stroke">
             <polyline points="20,40 60,20 100,40 140,20 180,40" fill="none" stroke="black" stroke-width="7" stroke-linejoin="round"/>
             <polygon points="195,38 175,23 175,53" fill="black"/>
             </g>
             </svg>
             </div>
             <div id="flecha-rayo3" class="flecha-rayo3">
             <svg width="310" height="80" viewBox="0 0 300 80">
             <g transform="scale(0.50) rotate(270 150 40)" vector-effect="non-scaling-stroke">
             <polyline points="20,40 60,20 100,40 140,20 180,40" fill="none" stroke="black" stroke-width="5" stroke-linejoin="round"/>
             <polygon points="195,38 175,23 175,53" fill="black"/>
             </g>
             </svg>
             </div>
             <div id="poste" class="poste">
             <svg width="100" height="200" viewBox="0 0 50 150">
             <rect x="22" y="30" width="6" height="100" fill="saddlebrown"></rect>
             <rect x="10" y="30" width="30" height="4" fill="sienna"></rect>
             <line x1="10" y1="32" x2="0" y2="20" stroke="black" stroke-width="2"></line>
             <line x1="40" y1="32" x2="50" y2="20" stroke="black" stroke-width="2"></line>
             <line x1="10" y1="34" x2="0" y2="40" stroke="black" stroke-width="2"></line>
             <line x1="40" y1="34" x2="50" y2="40" stroke="black" stroke-width="2"></line>
             <rect x="20" y="130" width="10" height="10" fill="gray"></rect>
             </svg>
             </div>
          </div>
         </div>
        </div>
      </div>


  <!-- TAB 1: ITR -->
  <div id="tab-1" class="tab-content">
    <div class="byte-info" id="byte-external-ITR">Esperando datos de ITR...</div>
    <div class="alarms-house-layout">
      <div class="alarms-container" id="alarms-external-ITR"></div>
      <div class="house-area">
        <div class="house-drawing">
          <div class="roof"></div>
          <div class="walls"></div>
          <div class="door"></div>
          <div class="window"></div>
          <div class="tank-container">
          <div id="diesel-tank">
          <div id="diesel-fill"></div>
          <div id="diesel-text">0%</div>
          </div>
        <div id="bateria" class="bateria">
          <svg width="100" height="140" viewBox="0 0 60 120">
          <rect x="0" y="20" width="60" height="50" rx="5" ry="5" fill="none" stroke="black" stroke-width="2"></rect>
          <line x1="15" y1="20" x2="15" y2="70" stroke="black" stroke-width="1"></line>
          <line x1="30" y1="20" x2="30" y2="70" stroke="black" stroke-width="1"></line>
          <line x1="45" y1="20" x2="45" y2="70" stroke="black" stroke-width="1"></line>
          <rect x="8" y="10" width="15" height="10" fill="red"></rect>
          <text x="15.5" y="18" font-size="10" text-anchor="middle" fill="white" font-family="Arial" font-weight="bold">+</text>
          <rect x="13" y="5" width="5" height="5" fill="red"></rect>
          <rect x="38" y="10" width="15" height="10" fill="black"></rect>
          <text x="45.5" y="18" font-size="10" text-anchor="middle" fill="white" font-family="Arial" font-weight="bold">-</text>
          <rect x="43" y="5" width="5" height="5" fill="black"></rect>
          </svg>
          </div>
          <div id="termometro" class="termometro">
          <svg width="45" height="154" viewBox="0 0 30 100">
          <g transform="scale(0.75)" vector-effect="non-scaling-stroke">
          <circle cx="15" cy="90" r="10" fill="red" stroke="black" stroke-width="2"></circle>
          <rect x="12" y="32" width="6" height="50" fill="none" stroke="black" stroke-width="2" rx="3"></rect>
          <rect x="13" y="40" width="4" height="50" fill="red"></rect>
          <line x1="18" y1="40" x2="22" y2="40" stroke="black" stroke-width="1"></line>
          <line x1="18" y1="50" x2="22" y2="50" stroke="black" stroke-width="1"></line>
          <line x1="18" y1="60" x2="22" y2="60" stroke="black" stroke-width="1"></line>
          <line x1="18" y1="70" x2="22" y2="70" stroke="black" stroke-width="1"></line>
          </g>
          </svg>
          </div>
          <div id="barra-tierra" class="barra-tierra">
          <svg width="160" height="80" viewBox="0 0 160 80" xmlns="http://www.w3.org/2000/svg">
          <g transform="scale(0.75)" vector-effect="non-scaling-stroke">
          <rect x="5" y="5" width="150" height="70" fill="none" stroke="black" stroke-width="2" rx="5" ry="5" />
          <line x1="80" y1="20" x2="80" y2="45" stroke="black" stroke-width="4" />
          <line x1="55" y1="45" x2="105" y2="45" stroke="black" stroke-width="4" />
          <line x1="60" y1="55" x2="100" y2="55" stroke="black" stroke-width="4" />
          <line x1="65" y1="65" x2="95"  y2="65" stroke="black" stroke-width="4" />
          </g>
          </svg>
          </div>
          <div id="rectificador" class="rectificador">
          <svg width="200" height="100" viewBox="0 0 200 100" xmlns="http://www.w3.org/2000/svg">
          <line x1="20" y1="20" x2="40" y2="20" stroke="black" stroke-width="3"/>
          <line x1="20" y1="60" x2="40" y2="60" stroke="black" stroke-width="3"/>
          <rect x="40" y="10" width="80" height="60" fill="none" stroke="black" stroke-width="3"/>
          <line x1="40" y1="10" x2="120" y2="70" stroke="black" stroke-width="1"/>
          <path d="M 47.5 45 q 17.5 -30 25 0 q 7.5 30 15 0" fill="none" stroke="black" stroke-width="3" />
          <line x1="80" y1="25" x2="100" y2="25" stroke="black" stroke-width="5" />
          <line x1="80" y1="30" x2="100" y2="30" stroke="black" stroke-width="3" />
          <line x1="120" y1="20" x2="140" y2="20" stroke="black" stroke-width="3" />
          <line x1="120" y1="60" x2="140" y2="60" stroke="black" stroke-width="3" />
          <text x="130" y="20" font-family="Arial" font-size="20" fill="black">+</text>
          <text x="130" y="60" font-family="Arial" font-size="20" fill="black">‚àí</text>
          </svg>
          </div>
          <div id="breaker" class="breaker">
          <svg width="90" height="60" viewBox="0 0 160 120" stroke="black" stroke-width="3" fill="none" stroke-linejoin="round">
          <g transform="scale(1.1)">
          <rect x="10" y="20" width="40" height="80" rx="2" ry="2"></rect>
          <rect x="60" y="20" width="40" height="80" rx="2" ry="2"></rect>
          <rect x="110" y="20" width="40" height="80" rx="2" ry="2"></rect>
          <rect x="18" y="10" width="20" height="10" rx="1" ry="1"></rect>
          <rect x="68" y="10" width="20" height="10" rx="1" ry="1"></rect>
          <rect x="118" y="10" width="20" height="10" rx="1" ry="1"></rect>
          <circle cx="28" cy="15" r="4"></circle>
          <circle cx="78" cy="15" r="4"></circle>
          <circle cx="128" cy="15" r="4"></circle>
          <rect x="18" y="100" width="20" height="10" rx="1" ry="1"></rect>
          <rect x="68" y="100" width="20" height="10" rx="1" ry="1"></rect>
          <rect x="118" y="100" width="20" height="10" rx="1" ry="1"></rect>
          <circle cx="28" cy="105" r="4"></circle>
          <circle cx="78" cy="105" r="4"></circle>
          <circle cx="128" cy="105" r="4"></circle>
          <rect x="25" y="50" width="10" height="25" rx="1" ry="1" fill="white" stroke="black" stroke-width="3"></rect>
          <line x1="30" y1="50" x2="30" y2="60" stroke="black" stroke-width="3" stroke-linecap="round"></line>
          <rect x="75" y="50" width="10" height="25" rx="1" ry="1" fill="white" stroke="black" stroke-width="3"></rect>
          <line x1="80" y1="50" x2="80" y2="60" stroke="black" stroke-width="3" stroke-linecap="round"></line>
          <rect x="125" y="50" width="10" height="25" rx="1" ry="1" fill="white" stroke="black" stroke-width="3"></rect>
          <line x1="130" y1="50" x2="130" y2="60" stroke="black" stroke-width="3" stroke-linecap="round"></line>
          </g>
          </svg>
          </div>
          <div id="persona" class="persona">
          <svg width="150" height="220" viewBox="0 0 120 180">
          <circle cx="52.5" cy="34" r="8" fill="none" stroke="black" stroke-width="3"/>
          <rect x="45" y="45" width="15" height="30" fill="none" stroke="black" stroke-width="3" rx="3"/>
          <rect x="40" y="45" width="5" height="25" fill="none" stroke="black" stroke-width="3" rx="3"/>
          <rect x="60" y="45" width="5" height="25" fill="none" stroke="black" stroke-width="3" rx="3" />
          <rect x="47.5" y="75" width="5" height="28" fill="none" stroke="black" stroke-width="3" rx="3"/>
          <rect x="52.5" y="75" width="5" height="28" fill="none" stroke="black" stroke-width="3" rx="3"/>
         </svg>
         </div>
          <div id="generador" class="generador">
            <svg width="200" height="150" viewBox="0 0 200 150">
            <rect class="gen-base" x="20" y="100" width="160" height="20" rx="4"></rect>
            <rect class="gen-body" x="40" y="40" width="120" height="60" rx="8"></rect>
            <text x="102" y="95" font-size="28" text-anchor="middle" fill="black" font-family="Arial" font-weight="bold">G E</text>
            <polyline points="100,45 90,70 110,70 100,95" stroke="orange" stroke-width="3" fill="none"></polyline>
            <circle cx="60" cy="60" r="5" fill="red"></circle>
            <circle cx="140" cy="60" r="5" fill="green"></circle>
            </svg>
          </div>
            <div id="ats" class="ats">
             <svg width="150" height="120" viewBox="0 0 150 120">
             <rect x="10" y="20" width="130" height="80" rx="10" fill="none" stroke="black" stroke-width="2"></rect>
             <text x="75" y="50" font-size="16" text-anchor="middle" fill="black" font-family="Arial" font-weight="bold">ATS</text>
             <line x1="75" y1="60" x2="75" y2="90" stroke="black" stroke-width="4" stroke-linecap="round"></line>
             <circle cx="75" cy="90" r="6" fill="gray" stroke="black" stroke-width="2"></circle>
             <text x="45" y="110" font-size="12" text-anchor="middle" fill="red" font-family="Arial" font-weight="bold">GEN</text>
             <text x="105" y="110" font-size="12" text-anchor="middle" fill="green" font-family="Arial" font-weight="bold">RED</text>
             <line x1="75" y1="90" x2="45" y2="105" stroke="red" stroke-width="2"></line>
             <line x1="75" y1="90" x2="105" y2="105" stroke="green" stroke-width="2"></line>
             </svg>
            </div>             
             <div id="poste" class="poste">
             <svg width="100" height="200" viewBox="0 0 50 150">
             <rect x="22" y="30" width="6" height="100" fill="saddlebrown"></rect>
             <rect x="10" y="30" width="30" height="4" fill="sienna"></rect>
             <line x1="10" y1="32" x2="0" y2="20" stroke="black" stroke-width="2"></line>
             <line x1="40" y1="32" x2="50" y2="20" stroke="black" stroke-width="2"></line>
             <line x1="10" y1="34" x2="0" y2="40" stroke="black" stroke-width="2"></line>
             <line x1="40" y1="34" x2="50" y2="40" stroke="black" stroke-width="2"></line>
             <rect x="20" y="130" width="10" height="10" fill="gray"></rect>
             </svg>
             </div>
           </div>
          </div>
         </div>
        </div>
      
  <script>
    // MQTT conexi√≥n WebSocket
    const client = mqtt.connect('wss://d4e6f442.ala.us-east-1.emqxsl.com:8084/mqtt', {
      clientId: 'web_' + Math.random().toString(16).substr(2, 8),
      username: 'Olivas',
      password: 'Jangel27'
    });

    const alarmNamesExternalOTY = [
      "FALLA*ALIM*COM*OTY","GPO*ELEC*OPER*OTY","FALLA*FUS*DIST*A*OTY","FALLA*RECT*A*OTY",
      "ALTA*TEMP*CX*OTY","FALLA*FUS*VOLTA*A*OTY","BAT*EN*OPER*A*OTY","BAJO*VOLTAJE*A*OTY",
      "ALARMA LIBRE 1","ALARMA LIBRE 2","ALARMA LIBRE 3","ALARMA LIBRE 4",
      "ALARMA LIBRE 5","ALARMA LIBRE 6","ALARMA LIBRE 7","ALARMA LIBRE 8"
    ];

    const alarmNamesExternalITR = [
      "FALLA*ALIM*COM*ITR","GPO*ELEC*OPER*ITR","FALLA*FUS*DIST*A*ITR","FALLA*RECT*A*ITR",
      "ALTA*TEMP*CX*ITR","FALLA*FUS*VOLTA*A*ITR","BAT*EN*OPER*A*ITR","BAJO*VOLTAJE*A*ITR",
      "ALARMA LIBRE 1","ALARMA LIBRE 2","ALARMA LIBRE 3","ALARMA LIBRE 4",
      "ALARMA LIBRE 5","ALARMA LIBRE 6","ALARMA LIBRE 7","ALARMA LIBRE 8"
    ];

    client.on('connect', () => {
      console.log('? Conectado a EMQX');
      client.subscribe('esp32/External_Alarms_OTY');
      client.subscribe('esp32/External_Alarms_ITR');
      client.subscribe('esp32/NivelDiesel_ITR');
    });

    client.on('message', (topic, message) => {
      if (topic === 'esp32/External_Alarms_OTY' || topic === 'esp32/External_Alarms_ITR') {
        const highByte = message[0];
        const lowByte = message[1];
        const value = (highByte << 8) | lowByte;
        const binStr = value.toString(2).padStart(16, '0');

        if (topic === 'esp32/External_Alarms_OTY') {
          document.getElementById('byte-external-OTY').textContent =
            `Bytes recibidos (OTY): ${highByte}, ${lowByte} | bin: ${binStr}`;
          updateAlarms('alarms-external-OTY', value, alarmNamesExternalOTY);
        } else {
          document.getElementById('byte-external-ITR').textContent =
            `Bytes recibidos (ITR): ${highByte}, ${lowByte} | bin: ${binStr}`;
          updateAlarms('alarms-external-ITR', value, alarmNamesExternalITR);
        }
      } else if (topic === 'esp32/NivelDiesel_ITR') {
        const porcentaje = parseInt(message.toString());
        updateDieselLevel(porcentaje);
      }
    });

    function toggleAlarmTab(tabIndex, isActive) {
      const tabs = document.querySelectorAll('.tab');
      if (!tabs[tabIndex]) return;
      tabs[tabIndex].classList.toggle('alarm-active-tab', isActive);
    }

    function showTab(index) {
      const tabs = document.querySelectorAll('.tab');
      const contents = document.querySelectorAll('.tab-content');
      tabs.forEach((tab, i) => {
        tab.classList.toggle('active', i === index);
        contents[i].classList.toggle('active', i === index);
      });
    }

    function updateDieselLevel(porcentaje) {
      const fill = document.getElementById('diesel-fill');
      const text = document.getElementById('diesel-text');
      const nivel = Math.max(0, Math.min(100, porcentaje));
      fill.style.height = `${nivel}%`;

      if (nivel < 20) {
        fill.style.background = 'linear-gradient(to top, #800000, #ff0000)';
      } else if (nivel < 50) {
        fill.style.background = 'linear-gradient(to top, #e6b800, #ffff00)';
      } else {
        fill.style.background = 'linear-gradient(to top, #007b00, #00ff00)';
      }

      text.textContent = `${nivel}%`;
    }

// === HISTORIAL POR PESTA√ëA ===
const alarmHistory = JSON.parse(localStorage.getItem('alarmHistory') || '{}');
if (!alarmHistory['OTY']) alarmHistory['OTY'] = [];
if (!alarmHistory['ITR']) alarmHistory['ITR'] = [];

function createHistoryContainers() {
  const otyTab = document.getElementById('tab-0');
  const itrTab = document.getElementById('tab-1');

  const otyHistoryDiv = document.createElement('div');
  otyHistoryDiv.innerHTML = `
    <h3>üìú Historial de Alarmas OTY</h3>
    <button class="clear-btn" onclick="clearHistory('OTY')">üßπ Limpiar Historial OTY</button>
    <ul id="history-OTY" class="history-box"></ul>
  `;
  otyTab.appendChild(otyHistoryDiv);

  const itrHistoryDiv = document.createElement('div');
  itrHistoryDiv.innerHTML = `
    <h3>üìú Historial de Alarmas ITR</h3>
    <button class="clear-btn" onclick="clearHistory('ITR')">üßπ Limpiar Historial ITR</button>
    <ul id="history-ITR" class="history-box"></ul>
  `;
  itrTab.appendChild(itrHistoryDiv);
}

createHistoryContainers();

function renderHistory(site) {
  const list = document.getElementById(`history-${site}`);
  list.innerHTML = '';
  alarmHistory[site].forEach(entry => addHistoryEntry(site, entry));
}

function addHistoryEntry(site, entry) {
  const list = document.getElementById(`history-${site}`);
  const li = document.createElement('li');
  li.textContent = `[${entry.time}] ${entry.name} ‚Üí ${entry.state}`;
  list.prepend(li);
}

function logAlarmChange(site, name, state) {
  // Solo registrar si hay un cambio de estado real (0‚Üí1 o 1‚Üí0)
  const timestamp = new Date().toLocaleString();
  const entry = { time: timestamp, name, state };
  alarmHistory[site].push(entry);
  localStorage.setItem('alarmHistory', JSON.stringify(alarmHistory));
  addHistoryEntry(site, entry);
}

function clearHistory(site) {
  if (confirm(`¬øSeguro que quieres borrar el historial de ${site}?`)) {
    alarmHistory[site] = [];
    localStorage.setItem('alarmHistory', JSON.stringify(alarmHistory));
    renderHistory(site);
  }
}

renderHistory('OTY');
renderHistory('ITR');

// === Detectar cambios de estado ===
let previousAlarmStates = {
  'alarms-external-OTY': null,
  'alarms-external-ITR': null
};

function updateAlarms(containerId, value16bit, alarmNames) {
  const container = document.getElementById(containerId);
  const prev = previousAlarmStates[containerId];
  const current = [];
  let hasActiveAlarm = false;

  container.innerHTML = '';

  // Recorremos de bit 0 a 15 (orden consistente)
  for (let i = 0; i < 16; i++) {
    const bit = (value16bit >> i) & 1;
    current[i] = bit;
    if (bit) hasActiveAlarm = true;

    // Solo registrar si ya hubo lectura previa y hay cambio
    if (prev && prev[i] !== bit) {
      const name = alarmNames[i];
      const site = containerId.includes('OTY') ? 'OTY' : 'ITR';
      const state = bit ? 'üö® ACTIVADA' : '‚úÖ CES√ì';
      logAlarmChange(site, name, state);
    }

    const div = document.createElement('div');
    div.className = 'alarm ' + (bit ? 'active' : 'inactive');
    div.textContent = `A${i} - ${alarmNames[i]}: ${bit ? 'üö® Alarma activa' : '‚úÖ Sin alarma'}`;
    container.appendChild(div);
  }

  previousAlarmStates[containerId] = current;

  if (containerId === 'alarms-external-OTY') toggleAlarmTab(0, hasActiveAlarm);
  if (containerId === 'alarms-external-ITR') toggleAlarmTab(1, hasActiveAlarm);
}
  </script>
</body>
</html>
