<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Monitor de Alarmas ESP32</title>
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
    }

    .tabs {
      display: flex;
      cursor: pointer;
      margin-bottom: 10px;
    }

    .tab {
      padding: 10px 20px;
      border: 1px solid #ccc;
      border-bottom: none;
      background-color: #f1f1f1;
    }

    .tab.active {
      background-color: white;
      font-weight: bold;
    }

    .tab.alarm-active-tab {
      background-color: red !important;
      color: white;
    }

    .tab-content {
     display: none;
      border: 1px solid #ccc;
      padding: 10px;
       /*background-color: #d8d8d8;*/
    }

    .tab-content.active {
      display: block;
    }

    .alarms-house-layout {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 20px;
    }

    .alarms-container {
      flex: 1;
    }

    .alarm {
      border: 1px solid #ccc;
      border-radius: 5px;
      padding: 10px;
      margin: 10px 0;
      font-size: 12px;
      width: 270px;
    }

    .active {
      background-color: #ffe5e5;
      color: #b30000;
      font-weight: bold;
    }

    .inactive {
      background-color: #e5ffe5;
      color: #007000;
    }

    .byte-info {
      font-size: 16px;
      font-weight: bold;
    }

    /* ====== Área de la casa ====== */
    .house-area {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-top: 40px;
    }

    .house-drawing {
      position: relative;
      width: 540px;
      height: 620px;
      top: -70px;
      left: -50px;
    }

    .roof {
      position: absolute;
      top: -60px;
      left: 0;
      width: 0;
      height: 0;
      border-left: 270px solid transparent;
      border-right: 270px solid transparent;
      border-bottom: 200px solid transparent;
    }

    .roof::before,
    .roof::after {
      content: "";
      position: absolute;
      top: 0;
      width: 2px;
      height: 320px;
      background-color: #000;
    }

    .roof::before {
      left: -270px;
      transform: rotate(57deg);
      transform-origin: bottom right;
    }

    .roof::after {
      right: -270px;
      transform: rotate(-57deg);
      transform-origin: bottom left;
    }

    .roof .base-line {
      position: absolute;
      bottom: 0;
      left: -270px;
      width: 540px;
      height: 2px;
      background-color: #000;
    }

    .walls {
      position: absolute;
      bottom: 0;
      width: 540px;
      height: 360px;
      background-color: transparent;
      border: 2px solid #000000;
      box-sizing: border-box;
    }

    .door {
      position: absolute;
      bottom: 0;
      left: 0;
      width: 180px;
      height: 220px;
      background-color: transparent;
      border: 2px solid #000000;
      box-sizing: border-box;
    }

    .window {
      position: absolute;
      bottom: 0;
      left: 360px;
      width: 180px;
      height: 220px;
      background-color: transparent;
      border: 2px solid #000000;
      box-sizing: border-box;
    }
    .bateria{
      position: absolute;
      bottom: -50px;
      left: 45px;
    }
    .persona{
      position: absolute;
      bottom: 15px;
      left: 30px;
    }
    .termometro{
      position: absolute;
      bottom: 220px;
      left: 250px;
    }
    .barra-tierra{
      position: absolute;
      bottom: 230px;
      left: 410px;
    }
    .rectificador{
      position: absolute;
      bottom: -10px;
      left: 385px;
    }
    .breaker{
      position: absolute;
      bottom: 120px;
      left: 395px;
    }

	.external-figures {
  	position: relative;       /* referencia para todas las figuras dentro */
  	width: 100%;
  	height: 300px;           /* ajusta según cuánto espacio debajo de la casa necesites */
  	margin-top: 20px;        /* separación de la casa */
	}
  	.tank-container {
  	position: absolute;
  	bottom: 0px; /* ajusta según la posición que quieras */
  	left: 10px;
	}

	#diesel-tank {
	position: absolute;
  	width: 155px;
  	height: 75px;
  	border: 4px solid #555;
  	border-radius: 60px;
  	background: radial-gradient(circle at 50% 30%, #fff176 0%, #FAD201 60%, #c9a801 100%);
  	box-shadow: inset -6px 0 10px rgba(0,0,0,0.3), inset 6px 0 10px rgba(255,255,255,0.5);
  	overflow: hidden;
  	position: relative;
	}

	#diesel-fill {	
	position: absolute;
  	bottom: 0;
  	left: 0;
  	width: 100%;
  	height: 0%;
  	background: linear-gradient(to top, #007b00, #00ff00);
  	border-radius: 0 0 40px 40px;
  	transition: height 0.8s ease, background 0.6s ease;
  	box-shadow: inset 0 2px 5px rgba(255,255,255,0.5);
	}

#diesel-text {
  position: absolute;
  width: 100%;
  text-align: center;
  bottom: 10px;
  font-weight: bold;
  color: #000;
  font-size: 20px;
  text-shadow: 1px 1px 2px rgba(255,255,255,0.9);
}

#diesel-title {
  position: absolute;
  top: -35px; /* justo encima del tanque */
  left: 50%;
  transform: translateX(-50%);
  font-size: 14px;
  font-weight: bold;
  color: #333;
  text-shadow: 1px 1px 2px rgba(255,255,255,0.8);
  pointer-events: none;
}

.generador {
  position: absolute;
  bottom: 20px;  /* ajusta según la posición que quieras */
  left: 130px;
}


    /* Solo líneas, sin relleno */
    .gen-body, .gen-base {
        fill: none;
        stroke: black;
        stroke-width: 2;
    }
    .button {
        margin: 10px;
        padding: 8px 12px;
        cursor: pointer;
    }
		.ats {
  		position: absolute;
  		bottom: 40px; /* ajusta según la posición deseada */
  		left: 350px;
	}
.flecha1 {
  position: absolute;
  bottom: 0px; /* ajusta según la posición deseada */
  left: 285px;
}

.flecha2 {
  position: absolute;
  bottom: 0px;
  left: 490px;
}

.flecha3 {
  position: absolute;
  bottom: 20px;
  left: 420px;
}

.flecha4 {
  position: absolute;
  bottom: -10px;
  left: 100px;
}
.poste {
  position: absolute;
  bottom: 30px; /* ajusta según la posición deseada */
  left: 515px;
}
    .history-box {
      background: #fff;
      border: 1px solid #ccc;
      padding: 10px;
      max-height: 200px;
      overflow-y: auto;
    }

    .clear-btn {
      margin: 5px 0;
      padding: 5px 10px;
      background: #ff6666;
      color: #fff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .clear-btn:hover {
      background: #e60000;
    }
    /* Color rojo a la figura */
		.alarm-figure-active svg * {
  	stroke: red !important;
  	fill: red !important;
		}

		/* Parpadeo cada 2 segundos */
		@keyframes parpadeo {
  	0%   { opacity: 1; }
  	50%  { opacity: 0.1; }
  	100% { opacity: 1; }
		}

		.alarm-blink {
  	animation: parpadeo 2s infinite;
		}

  </style>
</head>
<body>
<h2>Estado de Alarmas (desde ESP32 vía EMQX)</h2>

<div class="tabs">
	<div class="tab active" onclick="showTab(0)">Alarmas Externas OTY</div>
    <div class="tab" onclick="showTab(1)">Alarmas Externas ITR</div>
</div>

<!-- TAB 0: OTY -->
<div id="tab-0" class="tab-content active">
	<div class="byte-info" id="byte-external-OTY">Esperando datos de OTY...</div>
    <div class="alarms-house-layout">
		<!-- Contenedor de alarmas -->
    	<div class="alarms-container" id="alarms-external-OTY"></div>
		<!-- Área de la casa -->
      	<div class="house-area">
        	<div class="house-drawing">
          		<div class="roof"></div>
          		<div class="walls"></div>
          		<div class="door"></div>
          		<div class="window"></div>
			</div>
			<!-- Figuras dentro de la casa -->
          	<div id="bateria_OTY" class="bateria">
          		<svg width="100" height="140" viewBox="0 0 60 120">
          		<rect x="0" y="20" width="60" height="50" rx="5" ry="5" fill="none" stroke="black" stroke-width="2"></rect>
          		<line x1="15" y1="20" x2="15" y2="70" stroke="black" stroke-width="1"></line>
          		<line x1="30" y1="20" x2="30" y2="70" stroke="black" stroke-width="1"></line>
			    <line x1="45" y1="20" x2="45" y2="70" stroke="black" stroke-width="1"></line>
			    <rect x="8" y="10" width="15" height="10" fill="red"></rect>
			    <text x="15.5" y="18" font-size="10" text-anchor="middle" fill="white" font-family="Arial" font-weight="bold">+</text>
			    <rect x="13" y="5" width="5" height="5" fill="red"></rect>
			    <rect x="38" y="10" width="15" height="10" fill="black"></rect>
			    <text x="45.5" y="18" font-size="10" text-anchor="middle" fill="white" font-family="Arial" font-weight="bold">-</text>
			    <rect x="43" y="5" width="5" height="5" fill="black"></rect>
			    </svg>
			</div>
          	<div id="persona_OTY" class="persona">
          		<svg width="150" height="220" viewBox="0 0 120 180">
			    <circle cx="52.5" cy="34" r="8" fill="none" stroke="black" stroke-width="3"/>
			    <rect x="45" y="45" width="15" height="30" fill="none" stroke="black" stroke-width="3" rx="3"/>
			    <rect x="40" y="45" width="5" height="25" fill="none" stroke="black" stroke-width="3" rx="3"/>
			    <rect x="60" y="45" width="5" height="25" fill="none" stroke="black" stroke-width="3" rx="3" />
			    <rect x="47.5" y="75" width="5" height="28" fill="none" stroke="black" stroke-width="3" rx="3"/>
			    <rect x="52.5" y="75" width="5" height="28" fill="none" stroke="black" stroke-width="3" rx="3"/>
			    </svg>
			</div>
		    <div id="termometro_OTY" class="termometro">
		    	<svg width="45" height="154" viewBox="0 0 30 100">
		        <g transform="scale(0.75)" vector-effect="non-scaling-stroke">
		        <circle cx="15" cy="90" r="10" fill="red" stroke="black" stroke-width="2"></circle>
		        <rect x="12" y="32" width="6" height="50" fill="none" stroke="black" stroke-width="2" rx="3"></rect>
		        <rect x="13" y="40" width="4" height="50" fill="red"></rect>
		        <line x1="18" y1="40" x2="22" y2="40" stroke="black" stroke-width="1"></line>
		        <line x1="18" y1="50" x2="22" y2="50" stroke="black" stroke-width="1"></line>
		        <line x1="18" y1="60" x2="22" y2="60" stroke="black" stroke-width="1"></line>
		        <line x1="18" y1="70" x2="22" y2="70" stroke="black" stroke-width="1"></line>
		        </g>
		        </svg>
		    </div>
		    <div id="barra-tierra_OTY" class="barra-tierra">
		        <svg width="160" height="80" viewBox="0 0 160 80" xmlns="http://www.w3.org/2000/svg">
		        <g transform="scale(0.75)" vector-effect="non-scaling-stroke">
		        <rect x="5" y="5" width="150" height="70" fill="none" stroke="black" stroke-width="2" rx="5" ry="5" />
		        <line x1="80" y1="20" x2="80" y2="45" stroke="black" stroke-width="4" />
		        <line x1="55" y1="45" x2="105" y2="45" stroke="black" stroke-width="4" />
		        <line x1="60" y1="55" x2="100" y2="55" stroke="black" stroke-width="4" />
		        <line x1="65" y1="65" x2="95"  y2="65" stroke="black" stroke-width="4" />
		        </g>
		        </svg>
		    </div>
		    <div id="rectificador_OTY" class="rectificador">
		        <svg width="150" height="75" viewBox="0 0 200 100" xmlns="http://www.w3.org/2000/svg">
		    	<g transform="scale(0.75)">
		        <line x1="0" y1="30" x2="40" y2="30" stroke="black" stroke-width="3"/>
		        <line x1="0" y1="70" x2="40" y2="70" stroke="black" stroke-width="3"/>
		        <rect x="40" y="10" width="120" height="80" fill="none" stroke="black" stroke-width="3"/>
		        <line x1="40" y1="10" x2="160" y2="90" stroke="black" stroke-width="1"/>
		        <path d="M 50 60 q 10 -40 20 0 q 10 40 20 0" fill="none" stroke="black" stroke-width="3" />
		        <line x1="130" y1="35" x2="150" y2="35" stroke="black" stroke-width="5" />
		        <line x1="130" y1="45" x2="150" y2="45" stroke="black" stroke-width="3" />
		        <line x1="160" y1="30" x2="200" y2="30" stroke="black" stroke-width="3" />
		        <line x1="160" y1="70" x2="200" y2="70" stroke="black" stroke-width="3" />
		        <text x="205" y="35" font-family="Arial" font-size="20" fill="black">+</text>
		        <text x="205" y="75" font-family="Arial" font-size="20" fill="black">-</text>
		        </g>
		        </svg>
		    </div>
		    <div id="breaker_OTY" class="breaker">
		    	<svg width="90" height="60" viewBox="0 0 160 120" stroke="black" stroke-width="3" fill="none" stroke-linejoin="round">
		        <g transform="scale(1.1)">
		        <rect x="10" y="20" width="40" height="80" rx="2" ry="2"></rect>
		        <rect x="60" y="20" width="40" height="80" rx="2" ry="2"></rect>
		        <rect x="110" y="20" width="40" height="80" rx="2" ry="2"></rect>
		        <rect x="18" y="10" width="20" height="10" rx="1" ry="1"></rect>
		        <rect x="68" y="10" width="20" height="10" rx="1" ry="1"></rect>
		        <rect x="118" y="10" width="20" height="10" rx="1" ry="1"></rect>
		        <circle cx="28" cy="15" r="4"></circle>
		        <circle cx="78" cy="15" r="4"></circle>
		        <circle cx="128" cy="15" r="4"></circle>
		        <rect x="18" y="100" width="20" height="10" rx="1" ry="1"></rect>
		        <rect x="68" y="100" width="20" height="10" rx="1" ry="1"></rect>
		        <rect x="118" y="100" width="20" height="10" rx="1" ry="1"></rect>
		        <circle cx="28" cy="105" r="4"></circle>
		        <circle cx="78" cy="105" r="4"></circle>
		        <circle cx="128" cy="105" r="4"></circle>
		        <rect x="25" y="50" width="10" height="25" rx="1" ry="1" fill="white" stroke="black" stroke-width="3"></rect>
		        <line x1="30" y1="50" x2="30" y2="60" stroke="black" stroke-width="3" stroke-linecap="round"></line>
		        <rect x="75" y="50" width="10" height="25" rx="1" ry="1" fill="white" stroke="black" stroke-width="3"></rect>
		        <line x1="80" y1="50" x2="80" y2="60" stroke="black" stroke-width="3" stroke-linecap="round"></line>
		        <rect x="125" y="50" width="10" height="25" rx="1" ry="1" fill="white" stroke="black" stroke-width="3"></rect>
		        <line x1="130" y1="50" x2="130" y2="60" stroke="black" stroke-width="3" stroke-linecap="round"></line>
		        </g>
		        </svg>
		    </div>
		</div>
						
		<!-- Figuras externas: independientes de la casa -->
		<!-- Contenedor para figuras externas -->
	  	<div class="external-figures">
			<div id="generador_OTY" class="generador">
	        	<svg width="200" height="150" viewBox="0 0 200 150">
	        	<rect class="gen-base" x="20" y="100" width="160" height="20" rx="4"></rect>
	        	<rect class="gen-body" x="40" y="40" width="120" height="60" rx="8"></rect>
			    <text x="65" y="95" font-size="28" text-anchor="middle" fill="black" font-family="Arial" font-weight="bold">GE</text>
			    <polyline points="100,45 90,70 110,70 100,95" stroke="orange" stroke-width="3" fill="none"></polyline>
			    <circle cx="60" cy="60" r="5" fill="red"></circle>
			    <circle cx="140" cy="60" r="5" fill="green"></circle>
			    </svg>
			</div>
            <div id="ats_OTY" class="ats">
		        <svg width="150" height="120" viewBox="0 0 150 120">  
		        <rect x="10" y="20" width="130" height="80" rx="10" fill="none" stroke="black" stroke-width="2"></rect>
		        <text x="35" y="50" font-size="22" text-anchor="middle" fill="black" font-family="Arial" font-weight="bold">ATS</text>
		        <line x1="75" y1="70" x2="75" y2="25" stroke="black" stroke-width="4" stroke-linecap="round"></line>
		        <circle cx="75" cy="70" r="6" fill="gray" stroke="black" stroke-width="2"></circle>
		        <text x="30" y="85" font-size="14" text-anchor="middle" fill="red" font-family="Arial" font-weight="bold">GEN</text>
		        <text x="120" y="85" font-size="14" text-anchor="middle" fill="green" font-family="Arial" font-weight="bold">CFE</text>
		        <line x1="75" y1="70" x2="25" y2="70" stroke="red" stroke-width="3"></line>
		        <line x1="75" y1="70" x2="125" y2="70" stroke="green" stroke-width="3"></line>
		        </svg>
		    </div> 
             <div id="flecha1_OTY" class="flecha1">
	             <svg width="150" height="50">
	             <g transform="scale(0.50)" vector-effect="non-scaling-stroke">
	             <polygon points="20,15 95,15 95,5 135,25 95,45 95,35 20,35" fill="orange" stroke="black" stroke-width="3"/>
	             </g>
	             </svg>
             </div>
	        <div id="flecha2_OTY" class="flecha2">
		        <svg width="150" height="50">
		        <g transform="scale(0.50)" vector-effect="non-scaling-stroke">
		        <polygon points="130,15 50,15 50,5 10,25 50,45 50,35 130,35" fill="orange" stroke="black" stroke-width="3"/>
		        </g>
		        </svg>
	        </div>
			<div id="flecha3_OTY" class="flecha3">
             	<svg width="150" height="150">
             	<g transform="scale(0.50) rotate(-90, 75, 75)" vector-effect="non-scaling-stroke">
             	<polygon points="20,15 95,15 95,5 135,25 95,45 95,35 20,35" fill="orange" stroke="black" stroke-width="3"/>
             	</g>
             	</svg>
             </div>
             <div id="flecha4_OTY" class="flecha4">
             	<svg width="150" height="50">
             	<g transform="scale(0.50)" vector-effect="non-scaling-stroke">
             	<polygon points="20,15 95,15 95,5 135,25 95,45 95,35 20,35" fill="orange" stroke="black" stroke-width="3"/>
             	</g>
             	</svg>
             </div>
             <div id="poste_OTY" class="poste">
             	<svg width="100" height="200" viewBox="0 0 50 150">
             	<rect x="22" y="30" width="6" height="100" fill="saddlebrown"></rect>
             	<rect x="10" y="30" width="30" height="4" fill="sienna"></rect>
             	<line x1="10" y1="32" x2="0" y2="20" stroke="black" stroke-width="2"></line>
             	<line x1="40" y1="32" x2="50" y2="20" stroke="black" stroke-width="2"></line>
             	<line x1="10" y1="34" x2="0" y2="40" stroke="black" stroke-width="2"></line>
             	<line x1="40" y1="34" x2="50" y2="40" stroke="black" stroke-width="2"></line>
             	<rect x="20" y="130" width="10" height="10" fill="gray"></rect>
             	</svg>
             </div>
    	</div>
	</div>
</div>
	
<!-- TAB 1: ITR -->
<div id="tab-1" class="tab-content">
	<div class="byte-info" id="byte-external-ITR">Esperando datos de ITR...</div>
    <div class="alarms-house-layout">
		<!-- Contenedor de alarmas -->
      	<div class="alarms-container" id="alarms-external-ITR"></div>
		<!-- Área de la casa -->	
      	<div class="house-area">
        	<div class="house-drawing">
         		<div class="roof"></div>
          		<div class="walls"></div>
          		<div class="door"></div>
          		<div class="window"></div>
			</div>
			<!-- Figuras dentro de la casa -->
       	 	<div id="bateria_ITR" class="bateria">
          		<svg width="100" height="140" viewBox="0 0 60 120">
		        <rect x="0" y="20" width="60" height="50" rx="5" ry="5" fill="none" stroke="black" stroke-width="2"></rect>
		        <line x1="15" y1="20" x2="15" y2="70" stroke="black" stroke-width="1"></line>
		        <line x1="30" y1="20" x2="30" y2="70" stroke="black" stroke-width="1"></line>
		        <line x1="45" y1="20" x2="45" y2="70" stroke="black" stroke-width="1"></line>
		        <rect x="8" y="10" width="15" height="10" fill="red"></rect>
		        <text x="15.5" y="18" font-size="10" text-anchor="middle" fill="white" font-family="Arial" font-weight="bold">+</text>
		        <rect x="13" y="5" width="5" height="5" fill="red"></rect>
		        <rect x="38" y="10" width="15" height="10" fill="black"></rect>
		        <text x="45.5" y="18" font-size="10" text-anchor="middle" fill="white" font-family="Arial" font-weight="bold">-</text>
		        <rect x="43" y="5" width="5" height="5" fill="black"></rect>
		        </svg>
		    </div>
	        <div id="termometro_ITR" class="termometro">
	          	<svg width="45" height="154" viewBox="0 0 30 100">
	          	<g transform="scale(0.75)" vector-effect="non-scaling-stroke">
	          	<circle cx="15" cy="90" r="10" fill="red" stroke="black" stroke-width="2"></circle>
	          	<rect x="12" y="32" width="6" height="50" fill="none" stroke="black" stroke-width="2" rx="3"></rect>
	          	<rect x="13" y="40" width="4" height="50" fill="red"></rect>
	          	<line x1="18" y1="40" x2="22" y2="40" stroke="black" stroke-width="1"></line>
	          	<line x1="18" y1="50" x2="22" y2="50" stroke="black" stroke-width="1"></line>
	          	<line x1="18" y1="60" x2="22" y2="60" stroke="black" stroke-width="1"></line>
	          	<line x1="18" y1="70" x2="22" y2="70" stroke="black" stroke-width="1"></line>
	          	</g>
	          	</svg>
	        </div>
          	<div id="barra-tierra_ITR" class="barra-tierra">
          		<svg width="160" height="80" viewBox="0 0 160 80" xmlns="http://www.w3.org/2000/svg">
          		<g transform="scale(0.75)" vector-effect="non-scaling-stroke">
          		<rect x="5" y="5" width="150" height="70" fill="none" stroke="black" stroke-width="2" rx="5" ry="5" />
          		<line x1="80" y1="20" x2="80" y2="45" stroke="black" stroke-width="4" />
          		<line x1="55" y1="45" x2="105" y2="45" stroke="black" stroke-width="4" />
          		<line x1="60" y1="55" x2="100" y2="55" stroke="black" stroke-width="4" />
          		<line x1="65" y1="65" x2="95"  y2="65" stroke="black" stroke-width="4" />
          		</g>
          		</svg>
          	</div>
          	<div id="rectificador_ITR" class="rectificador">
          		<svg width="150" height="75" viewBox="0 0 200 100" xmlns="http://www.w3.org/2000/svg">
          		<g transform="scale(0.75)">
          		<line x1="0" y1="30" x2="40" y2="30" stroke="black" stroke-width="3"/>
          		<line x1="0" y1="70" x2="40" y2="70" stroke="black" stroke-width="3"/>
          		<rect x="40" y="10" width="120" height="80" fill="none" stroke="black" stroke-width="3"/>
          		<line x1="40" y1="10" x2="160" y2="90" stroke="black" stroke-width="1"/>
          		<path d="M 50 60 q 10 -40 20 0 q 10 40 20 0" fill="none" stroke="black" stroke-width="3" />
          		<line x1="130" y1="35" x2="150" y2="35" stroke="black" stroke-width="5" />
          		<line x1="130" y1="45" x2="150" y2="45" stroke="black" stroke-width="3" />
          		<line x1="160" y1="30" x2="200" y2="30" stroke="black" stroke-width="3" />
          		<line x1="160" y1="70" x2="200" y2="70" stroke="black" stroke-width="3" />
          		<text x="205" y="35" font-family="Arial" font-size="20" fill="black">+</text>
          		<text x="205" y="75" font-family="Arial" font-size="20" fill="black">-</text>
          		</g>
          		</svg>
          	</div>
	        <div id="breaker_ITR" class="breaker">
	          	<svg width="90" height="60" viewBox="0 0 160 120" stroke="black" stroke-width="3" fill="none" stroke-linejoin="round">
	          	<g transform="scale(1.1)">
	          	<rect x="10" y="20" width="40" height="80" rx="2" ry="2"></rect>
	          	<rect x="60" y="20" width="40" height="80" rx="2" ry="2"></rect>
	          	<rect x="110" y="20" width="40" height="80" rx="2" ry="2"></rect>
	          	<rect x="18" y="10" width="20" height="10" rx="1" ry="1"></rect>
	          	<rect x="68" y="10" width="20" height="10" rx="1" ry="1"></rect>
	          	<rect x="118" y="10" width="20" height="10" rx="1" ry="1"></rect>
	          	<circle cx="28" cy="15" r="4"></circle>
	          	<circle cx="78" cy="15" r="4"></circle>
	          	<circle cx="128" cy="15" r="4"></circle>
	          	<rect x="18" y="100" width="20" height="10" rx="1" ry="1"></rect>
	          	<rect x="68" y="100" width="20" height="10" rx="1" ry="1"></rect>
	          	<rect x="118" y="100" width="20" height="10" rx="1" ry="1"></rect>
	          	<circle cx="28" cy="105" r="4"></circle>
	          	<circle cx="78" cy="105" r="4"></circle>
	          	<circle cx="128" cy="105" r="4"></circle>
	          	<rect x="25" y="50" width="10" height="25" rx="1" ry="1" fill="white" stroke="black" stroke-width="3"></rect>
	          	<line x1="30" y1="50" x2="30" y2="60" stroke="black" stroke-width="3" stroke-linecap="round"></line>
	          	<rect x="75" y="50" width="10" height="25" rx="1" ry="1" fill="white" stroke="black" stroke-width="3"></rect>
	          	<line x1="80" y1="50" x2="80" y2="60" stroke="black" stroke-width="3" stroke-linecap="round"></line>
	          	<rect x="125" y="50" width="10" height="25" rx="1" ry="1" fill="white" stroke="black" stroke-width="3"></rect>
	          	<line x1="130" y1="50" x2="130" y2="60" stroke="black" stroke-width="3" stroke-linecap="round"></line>
	          	</g>
	          	</svg>
	        </div>
          	<div id="persona_ITR" class="persona">
          		<svg width="150" height="220" viewBox="0 0 120 180">
          		<circle cx="52.5" cy="34" r="8" fill="none" stroke="black" stroke-width="3"/>
          		<rect x="45" y="45" width="15" height="30" fill="none" stroke="black" stroke-width="3" rx="3"/>
          		<rect x="40" y="45" width="5" height="25" fill="none" stroke="black" stroke-width="3" rx="3"/>
         		<rect x="60" y="45" width="5" height="25" fill="none" stroke="black" stroke-width="3" rx="3" />
          		<rect x="47.5" y="75" width="5" height="28" fill="none" stroke="black" stroke-width="3" rx="3"/>
          		<rect x="52.5" y="75" width="5" height="28" fill="none" stroke="black" stroke-width="3" rx="3"/>
         		</svg>
         	</div>
		</div>
		<!-- Figuras externas: independientes de la casa -->
		<!-- Contenedor para figuras externas -->
  		<div class="external-figures">
			<div class="tank-area">
  				<div id="diesel-title">Nivel Diesel</div>
  				<div id="diesel-tank">
   					<div id="diesel-fill"></div>
    				<div id="diesel-text">0%</div>
  				</div>
			</div>
          	<div id="generador_ITR" class="generador">
            	<svg width="200" height="150" viewBox="0 0 200 150">
	            <rect class="gen-base" x="20" y="100" width="160" height="20" rx="4"></rect>
	            <rect class="gen-body" x="40" y="40" width="120" height="60" rx="8"></rect>
	            <text x="65" y="95" font-size="28" text-anchor="middle" fill="black" font-family="Arial" font-weight="bold">GE</text>
	            <polyline points="100,45 90,70 110,70 100,95" stroke="orange" stroke-width="3" fill="none"></polyline>
	            <circle cx="60" cy="60" r="5" fill="red"></circle>
	            <circle cx="140" cy="60" r="5" fill="green"></circle>
	            </svg>
	        </div>
            <div id="ats_ITR" class="ats">
             	<svg width="150" height="120" viewBox="0 0 150 120">  
	            <rect x="10" y="20" width="130" height="80" rx="10" fill="none" stroke="black" stroke-width="2"></rect>
	        	<text x="35" y="50" font-size="22" text-anchor="middle" fill="black" font-family="Arial" font-weight="bold">ATS</text>
	            <line x1="75" y1="70" x2="75" y2="25" stroke="black" stroke-width="4" stroke-linecap="round"></line>
	            <circle cx="75" cy="70" r="6" fill="gray" stroke="black" stroke-width="2"></circle>
	            <text x="30" y="85" font-size="14" text-anchor="middle" fill="red" font-family="Arial" font-weight="bold">GEN</text>
	            <text x="120" y="85" font-size="14" text-anchor="middle" fill="green" font-family="Arial" font-weight="bold">CFE</text>
	            <line x1="75" y1="70" x2="25" y2="70" stroke="red" stroke-width="3"></line>
	            <line x1="75" y1="70" x2="125" y2="70" stroke="green" stroke-width="3"></line>
	            </svg>
	        </div> 
            <div id="flecha1_ITR" class="flecha1">
            	<svg width="150" height="50">
            	<g transform="scale(0.50)" vector-effect="non-scaling-stroke">
             	<polygon points="20,15 95,15 95,5 135,25 95,45 95,35 20,35" fill="orange" stroke="black" stroke-width="3"/>
             	</g>
             	</svg>
            </div>
            <div id="flecha2_ITR" class="flecha2">
             	<svg width="150" height="50">
             	<g transform="scale(0.50)" vector-effect="non-scaling-stroke">
             	<polygon points="130,15 50,15 50,5 10,25 50,45 50,35 130,35" fill="orange" stroke="black" stroke-width="3"/>
             	</g>
             	</svg>
            </div>
            <div id="flecha3_ITR" class="flecha3">
             	<svg width="150" height="150">
             	<g transform="scale(0.50) rotate(-90, 75, 75)" vector-effect="non-scaling-stroke">
             	<polygon points="20,15 95,15 95,5 135,25 95,45 95,35 20,35" fill="orange" stroke="black" stroke-width="3"/>
             	</g>
             	</svg>
        	</div>
            <div id="flecha4_ITR" class="flecha4">
             	<svg width="150" height="50">
             	<g transform="scale(0.50)" vector-effect="non-scaling-stroke">
             	<polygon points="20,15 95,15 95,5 135,25 95,45 95,35 20,35" fill="orange" stroke="black" stroke-width="3"/>
             	</g>
             	</svg>
        	</div>
            <div id="poste_ITR" class="poste">
             	<svg width="100" height="200" viewBox="0 0 50 150">
             	<rect x="22" y="30" width="6" height="100" fill="saddlebrown"></rect>
             	<rect x="10" y="30" width="30" height="4" fill="sienna"></rect>
             	<line x1="10" y1="32" x2="0" y2="20" stroke="black" stroke-width="2"></line>
             	<line x1="40" y1="32" x2="50" y2="20" stroke="black" stroke-width="2"></line>
             	<line x1="10" y1="34" x2="0" y2="40" stroke="black" stroke-width="2"></line>
             	<line x1="40" y1="34" x2="50" y2="40" stroke="black" stroke-width="2"></line>
             	<rect x="20" y="130" width="10" height="10" fill="gray"></rect>
             	</svg>
            </div>
        </div>
    </div>
</div>
            
  <script>
    // MQTT conexión WebSocket
    const client = mqtt.connect('wss://d4e6f442.ala.us-east-1.emqxsl.com:8084/mqtt', {
      clientId: 'web_' + Math.random().toString(16).substr(2, 8),
      username: 'Olivas',
      password: 'Jangel27'
    });

    const alarmNamesExternalOTY = [
      "FALLA*ALIM*COM*OTY","GPO*ELEC*OPER*OTY","FALLA*FUS*DIST*A*OTY","FALLA*RECT*A*OTY",
      "ALTA*TEMP*CX*OTY","FALLA*FUS*VOLTA*A*OTY","BAT*EN*OPER*A*OTY","BAJO*VOLTAJE*A*OTY",
      "PRESENCIA*BANCO*BAT*OTY","ROBO*BARRA*TIERRA*OTY","ALARMA LIBRE 3","ALARMA LIBRE 4",
      "ALARMA LIBRE 5","ALARMA LIBRE 6","ALARMA LIBRE 7","ALARMA LIBRE 8"
    ];

    const alarmNamesExternalITR = [
      "FALLA*ALIM*COM*ITR","GPO*ELEC*OPER*ITR","FALLA*FUS*DIST*A*ITR","FALLA*RECT*A*ITR",
      "ALTA*TEMP*CX*ITR","FALLA*FUS*VOLTA*A*ITR","BAT*EN*OPER*A*ITR","BAJO*VOLTAJE*A*ITR",
      "PRESENCIA*BANCO*BAT*ITR","ROBO*BARRA*TIERRA*ITR","ALARMA LIBRE 3","ALARMA LIBRE 4",
      "ALARMA LIBRE 5","ALARMA LIBRE 6","ALARMA LIBRE 7","ALARMA LIBRE 8"
    ];

    client.on('connect', () => {
      console.log('? Conectado a EMQX');
      client.subscribe('esp32/External_Alarms_OTY');
      client.subscribe('esp32/External_Alarms_ITR');
      client.subscribe('esp32/NivelDiesel_ITR');
    });

    client.on('message', (topic, message) => {
      if (topic === 'esp32/External_Alarms_OTY' || topic === 'esp32/External_Alarms_ITR') {
        const highByte = message[0];
        const lowByte = message[1];
        const value = (highByte << 8) | lowByte;
        const binStr = value.toString(2).padStart(16, '0');

        if (topic === 'esp32/External_Alarms_OTY') {
          document.getElementById('byte-external-OTY').textContent =
            `Bytes recibidos (OTY): ${highByte}, ${lowByte} | bin: ${binStr}`;
          updateAlarms('alarms-external-OTY', value, alarmNamesExternalOTY);
        } else {
          document.getElementById('byte-external-ITR').textContent =
            `Bytes recibidos (ITR): ${highByte}, ${lowByte} | bin: ${binStr}`;
            
          updateAlarms('alarms-external-ITR', value, alarmNamesExternalITR);
        }
      } else if (topic === 'esp32/NivelDiesel_ITR') {
        const porcentaje = parseInt(message.toString());
        updateDieselLevel(porcentaje);
      }
    });

    function toggleAlarmTab(tabIndex, isActive) {
      const tabs = document.querySelectorAll('.tab');
      if (!tabs[tabIndex]) return;
      tabs[tabIndex].classList.toggle('alarm-active-tab', isActive);
    }

    function showTab(index) {
      const tabs = document.querySelectorAll('.tab');
      const contents = document.querySelectorAll('.tab-content');
      tabs.forEach((tab, i) => {
        tab.classList.toggle('active', i === index);
        contents[i].classList.toggle('active', i === index);
      });
    }

    function updateDieselLevel(porcentaje) {
      const fill = document.getElementById('diesel-fill');
      const text = document.getElementById('diesel-text');
      const nivel = Math.max(0, Math.min(100, porcentaje));
      fill.style.height = `${nivel}%`;

      if (nivel < 20) {
        fill.style.background = 'linear-gradient(to top, #800000, #ff0000)';
      } else if (nivel < 50) {
        fill.style.background = 'linear-gradient(to top, #e6b800, #ffff00)';
      } else {
        fill.style.background = 'linear-gradient(to top, #007b00, #00ff00)';
      }
      text.textContent = `${nivel}%`;
    }

// === HISTORIAL POR PESTAÑA ===
const alarmHistory = JSON.parse(localStorage.getItem('alarmHistory') || '{}');
if (!alarmHistory['OTY']) alarmHistory['OTY'] = [];
if (!alarmHistory['ITR']) alarmHistory['ITR'] = [];

function createHistoryContainers() {
  const otyTab = document.getElementById('tab-0');
  const itrTab = document.getElementById('tab-1');

  const otyHistoryDiv = document.createElement('div');
  otyHistoryDiv.innerHTML = `
    <h3>?? Historial de Alarmas OTY</h3>
    <button class="clear-btn" onclick="clearHistory('OTY')">?? Limpiar Historial OTY</button>
    <ul id="history-OTY" class="history-box"></ul>
  `;
  otyTab.appendChild(otyHistoryDiv);

  const itrHistoryDiv = document.createElement('div');
  itrHistoryDiv.innerHTML = `
    <h3>?? Historial de Alarmas ITR</h3>
    <button class="clear-btn" onclick="clearHistory('ITR')">?? Limpiar Historial ITR</button>
    <ul id="history-ITR" class="history-box"></ul>
  `;
  itrTab.appendChild(itrHistoryDiv);
}

createHistoryContainers();

function renderHistory(site) {
  const list = document.getElementById(`history-${site}`);
  list.innerHTML = '';
  alarmHistory[site].forEach(entry => addHistoryEntry(site, entry));
}

function addHistoryEntry(site, entry) {
  const list = document.getElementById(`history-${site}`);
  const li = document.createElement('li');
  li.textContent = `[${entry.time}] ${entry.name} ? ${entry.state}`;
  list.prepend(li);
}

function logAlarmChange(site, name, state) {
  // Solo registrar si hay un cambio de estado real (0?1 o 1?0)
  const timestamp = new Date().toLocaleString();
  const entry = { time: timestamp, name, state };
  alarmHistory[site].push(entry);
  localStorage.setItem('alarmHistory', JSON.stringify(alarmHistory));
  addHistoryEntry(site, entry);
}

function clearHistory(site) {
  if (confirm(`¿Seguro que quieres borrar el historial de ${site}?`)) {
    alarmHistory[site] = [];
    localStorage.setItem('alarmHistory', JSON.stringify(alarmHistory));
    renderHistory(site);
  }
}

renderHistory('OTY');
renderHistory('ITR');

// === Detectar cambios de estado ===
let previousAlarmStates = {
  'alarms-external-OTY': null,
  'alarms-external-ITR': null
};
// Mapa de alarmas -> figuras 
const figureMapOTY = {
  	0: "poste_OTY",
  	1: "generador_OTY",
  	2: "breaker_OTY",
  	3: "rectificador_OTY",
  	4: "termometro_OTY",
  	5: "bateria_OTY",
  	6: "bateria_OTY",
	7: "bateria_OTY",
  	8: "persona_OTY",
  	9: "barra-tierra_OTY",
};
const figureMapITR = {
	0: "poste_ITR",
	1: "generador_ITR",
  	2: "breaker_ITR",
  	3: "rectificador_ITR",
 	4: "termometro_ITR",
  	5: "bateria_ITR",
  	6: "bateria_ITR",
	7: "bateria_ITR",
  	8: "persona_ITR",
  	9: "barra-tierra_ITR",
};

function updateAlarms(containerId, value16bit, alarmNames) {
  const container = document.getElementById(containerId);
  const prev = previousAlarmStates[containerId];
  const current = [];
  let hasActiveAlarm = false;
// Seleccionar el mapa de figuras según la pestaña
  let figureMap = null;

if (containerId === "alarms-external-OTY") figureMap = figureMapOTY;
if (containerId === "alarms-external-ITR") figureMap = figureMapITR;
  
	container.innerHTML = '';

  // Recorremos de bit 0 a 15 (orden consistente)
  for (let i = 0; i < 16; i++) {
    const bit = (value16bit >> i) & 1;
    // === Control de figuras SOLO de la pestaña correspondiente ===
	if (figureMap && figureMap[i]) {
  	const fig = document.getElementById(figureMap[i]);
  	if (fig) {
    if (bit) {
      fig.classList.add("alarm-figure-active");
      fig.classList.add("alarm-blink");      // <- PARPADEO
    } else {
      fig.classList.remove("alarm-figure-active");
      fig.classList.remove("alarm-blink");
    }
  }
}
    current[i] = bit;
    if (bit) hasActiveAlarm = true;

    // Solo registrar si ya hubo lectura previa y hay cambio
    if (prev && prev[i] !== undefined && prev[i] !== bit) {
      const name = alarmNames[i];
      const site = containerId.includes('OTY') ? 'OTY' : 'ITR';
      const state = bit ? '?? ACTIVADA' : '?? CESÓ';
      logAlarmChange(site, name, state);
    }
// --- Construcción visual ---
    const div = document.createElement('div');
    div.className = 'alarm ' + (bit ? 'active' : 'inactive');
    div.textContent = `A${i} - ${alarmNames[i]}: ${bit ? '?? Alarma activa' : '? Sin alarma'}`;
    container.appendChild(div);
  }
  previousAlarmStates[containerId] = current;

  if (containerId === 'alarms-external-OTY') toggleAlarmTab(0, hasActiveAlarm);
  if (containerId === 'alarms-external-ITR') toggleAlarmTab(1, hasActiveAlarm);
}
  </script>
</body>
</html>
