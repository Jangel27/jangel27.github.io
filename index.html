<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Monitor de Alarmas ESP32</title>
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; }

    .tabs { display: flex; cursor: pointer; margin-bottom: 10px; }
    .tab { padding: 10px 20px; border: 1px solid #ccc; border-bottom: none; background-color: #f1f1f1; }
    .tab.active { background-color: white; font-weight: bold; }
    .tab.alarm-active-tab { background-color: red !important; color: white; }
    .tab-content { display: none; border: 1px solid #ccc; padding: 10px; background-color: #d8d8d8; }
    .tab-content.active { display: block; }

    .alarms-house-layout { display: flex; justify-content: space-between; align-items: flex-start; gap: 20px; }
    .alarms-container { flex: 1; }

    .alarm { border: 1px solid #ccc; border-radius: 5px; padding: 10px; margin: 10px 0; font-size: 12px; width: 270px; }
    .active { background-color: #ffe5e5; color: #b30000; font-weight: bold; }
    .inactive { background-color: #e5ffe5; color: #007000; }

    .byte-info { font-size: 16px; font-weight: bold; }

    /* ====== Área de la casa ====== */
    .house-area { display: flex; flex-direction: column; align-items: center; margin-top: 40px; }
    .house-drawing { position: relative; width: 540px; height: 620px; top: -70px; left: -50px; }
    .roof { position: absolute; top: -60px; left: 0; width: 0; height: 0; border-left: 270px solid transparent; border-right: 270px solid transparent; border-bottom: 200px solid transparent; }
    .roof::before, .roof::after { content: ""; position: absolute; top: 0; width: 2px; height: 320px; background-color: #000; }
    .roof::before { left: -270px; transform: rotate(57deg); transform-origin: bottom right; }
    .roof::after { right: -270px; transform: rotate(-57deg); transform-origin: bottom left; }
    .roof .base-line { position: absolute; bottom: 0; left: -270px; width: 540px; height: 2px; background-color: #000; }

    .walls { position: absolute; bottom: 0; width: 540px; height: 360px; background-color: transparent; border: 2px solid #000000; box-sizing: border-box; }
    .door { position: absolute; bottom: 0; left: 0; width: 150px; height: 220px; background-color: transparent; border: 2px solid #000000; box-sizing: border-box; }
    .window { position: absolute; bottom: 0; left: 390px; width: 150px; height: 220px; background-color: transparent; border: 2px solid #000000; box-sizing: border-box; }

    .tank-container { display: flex; justify-content: center; align-items: center; }
    #diesel-tank { position: absolute; bottom: -220px; left: -60px; width: 150px; height: 75px; border: 4px solid #555; border-radius: 60px; background: radial-gradient(circle at 50% 30%, #fff176 0%, #FAD201 60%, #c9a801 100%); box-shadow: inset -6px 0 10px rgba(0, 0, 0, 0.3), inset 6px 0 10px rgba(255, 255, 255, 0.5); overflow: hidden; }
    #diesel-fill { position: absolute; bottom: 0; left: 0; width: 100%; height: 0%; background: linear-gradient(to top, #007b00, #00ff00); border-radius: 0 0 40px 40px; transition: height 0.8s ease, background 0.6s ease; box-shadow: inset 0 2px 5px rgba(255, 255, 255, 0.5); }
    #diesel-text { position: absolute; width: 100%; text-align: center; bottom: 10px; font-weight: bold; color: #000; font-size: 20px; text-shadow: 1px 1px 2px rgba(255,255,255,0.9); }

    .history-box { background: #fff; border: 1px solid #ccc; padding: 10px; max-height: 200px; overflow-y: auto; }
    .clear-btn { margin: 5px 0; padding: 5px 10px; background: #ff6666; color: #fff; border: none; border-radius: 4px; cursor: pointer; }
    .clear-btn:hover { background: #e60000; }

    /* ====== Animación de alarma para figuras ====== */
    @keyframes parpadeo-alarma { 0%,100%{fill:red;}50%{fill:transparent;} }
    .en-alarma { animation: parpadeo-alarma 1s ease-in-out infinite alternate; }
  </style>
</head>
<body>
<h2>Estado de Alarmas (desde ESP32 vía EMQX)</h2>

<div class="tabs">
  <div class="tab active" onclick="showTab(0)">Alarmas Externas OTY</div>
  <div class="tab" onclick="showTab(1)">Alarmas Externas ITR</div>
</div>

<!-- TAB 0: OTY -->
<div id="tab-0" class="tab-content active">
  <div class="byte-info" id="byte-external-OTY">Esperando datos de OTY...</div>
  <div class="alarms-house-layout">
    <div class="alarms-container" id="alarms-external-OTY"></div>
    <div class="house-area">
      <div class="house-drawing" id="house-OTY">
        <div class="roof"></div>
        <div class="walls"></div>
        <div class="door"></div>
        <div class="window"></div>
      </div>
    </div>
  </div>
</div>

<!-- TAB 1: ITR -->
<div id="tab-1" class="tab-content">
  <div class="byte-info" id="byte-external-ITR">Esperando datos de ITR...</div>
  <div class="alarms-house-layout">
    <div class="alarms-container" id="alarms-external-ITR"></div>
    <div class="house-area">
      <div class="house-drawing" id="house-ITR">
        <div class="roof"></div>
        <div class="walls"></div>
        <div class="door"></div>
        <div class="window"></div>
      </div>
    </div>
  </div>
</div>

<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
<script>

    // MQTT conexión WebSocket
    const client = mqtt.connect('wss://d4e6f442.ala.us-east-1.emqxsl.com:8084/mqtt', {
      clientId: 'web_' + Math.random().toString(16).substr(2, 8),
      username: 'Olivas',
      password: 'Jangel27'
    });

  const alarmNamesExternalOTY = [
    "FALLAALIMCOM*OTY","GPOELECOPER*OTY","FALLAFUSDISTAOTY","FALLARECTA*OTY",
    "ALTATEMPCX*OTY","FALLAFUSVOLTAAOTY","BATENOPERAOTY","BAJOVOLTAJEA*OTY",
    "ALARMA LIBRE 1","ALARMA LIBRE 2"
  ];

  const alarmNamesExternalITR = [
    "FALLAALIMCOM*ITR","GPOELECOPER*ITR","FALLAFUSDISTAITR","FALLARECTA*ITR",
    "ALTATEMPCX*ITR","FALLAFUSVOLTAAITR","BATENOPERAITR","BAJOVOLTAJEITR",
    "ALARMA LIBRE 1","ALARMA LIBRE 2"
  ];

  // === Crear figuras en la casa ===
  const figuraSVGs = {
    "poste": `<svg width="50" height="100"><rect x="20" y="10" width="10" height="80" fill="gray" /></svg>`,
    "generador": `<svg width="60" height="50"><rect x="10" y="10" width="40" height="30" fill="green" /></svg>`,
    "circuit-breaker": `<svg width="60" height="50"><rect x="10" y="10" width="40" height="30" fill="blue" /></svg>`,
    "rectificador-simbolo": `<svg width="60" height="50"><rect x="10" y="10" width="40" height="30" fill="orange" /></svg>`,
    "termometro": `<svg width="20" height="50"><rect x="5" y="5" width="10" height="40" fill="red" /></svg>`,
    "bateria": `<svg width="40" height="30"><rect x="5" y="5" width="30" height="20" fill="yellow" /></svg>`,
    "persona": `<svg width="30" height="50"><circle cx="15" cy="10" r="10" fill="purple" /></svg>`,
    "barra-tierra": `<svg width="50" height="10"><rect x="0" y="0" width="50" height="10" fill="brown" /></svg>`
  };

  // Asignación de bits ? figura
  const alarmBitToFigura = [
    "poste","generador","circuit-breaker","rectificador-simbolo",
    "termometro","bateria","bateria","bateria",
    "persona","barra-tierra"
  ];

  function createFigures(tab) {
    const houseDiv = document.getElementById(tab==='OTY'?'house-OTY':'house-ITR');
    // Crear elementos SVG por cada figura
    houseDiv.figuras = [];
    alarmBitToFigura.forEach((nombreFigura, i) => {
      const wrapper = document.createElement('div');
      wrapper.innerHTML = figuraSVGs[nombreFigura];
      const svg = wrapper.firstChild;
      svg.classList.add('figura');
      houseDiv.appendChild(svg);
      houseDiv.figuras[i] = svg;
    });
  }

  createFigures('OTY');
  createFigures('ITR');

  function toggleAlarmFigura(tab, bitIndex, activo) {
    const houseDiv = document.getElementById(tab==='OTY'?'house-OTY':'house-ITR');
    if(houseDiv && houseDiv.figuras && houseDiv.figuras[bitIndex]){
      if(activo) houseDiv.figuras[bitIndex].classList.add('en-alarma');
      else houseDiv.figuras[bitIndex].classList.remove('en-alarma');
    }
  }

  // MQTT
  client.on('connect', () => {
    console.log('Conectado a EMQX');
    client.subscribe('esp32/External_Alarms_OTY');
    client.subscribe('esp32/External_Alarms_ITR');
  });

  let previousAlarmStates = { 'OTY':[], 'ITR':[] };

  client.on('message', (topic, message) => {
    const highByte = message[0], lowByte = message[1];
    const value = (highByte<<8)|lowByte;
    let tab = null, alarmNames = null;
    if(topic==='esp32/External_Alarms_OTY'){ tab='OTY'; alarmNames = alarmNamesExternalOTY; document.getElementById('byte-external-OTY').textContent=`Bytes recibidos (OTY): ${highByte}, ${lowByte} | bin: ${value.toString(2).padStart(16,'0')}`; }
    if(topic==='esp32/External_Alarms_ITR'){ tab='ITR'; alarmNames = alarmNamesExternalITR; document.getElementById('byte-external-ITR').textContent=`Bytes recibidos (ITR): ${highByte}, ${lowByte} | bin: ${value.toString(2).padStart(16,'0')}`; }
    if(!tab) return;

    // Actualizar figuras y estado
    for(let i=0;i<alarmBitToFigura.length;i++){
      const bit = (value>>i)&1;
      toggleAlarmFigura(tab,i,bit);
    }
  });

  function showTab(index){
    const tabs = document.querySelectorAll('.tab');
    const contents = document.querySelectorAll('.tab-content');
    tabs.forEach((tab,i)=>tab.classList.toggle('active',i===index));
    contents.forEach((c,i)=>c.classList.toggle('active',i===index));
  }
</script>
</body>
</html>
